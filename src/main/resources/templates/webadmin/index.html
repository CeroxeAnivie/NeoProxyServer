<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"
          name="viewport">
    <title data-i18n="app_title">NeoProxy Admin</title>
    <link href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%237C3AED'/><stop offset='100%' stop-color='%2306B6D4'/></linearGradient></defs><path d='M20 85 V 15 L 80 85 V 15' stroke='url(%23g)' stroke-width='20' stroke-linecap='round' fill='none'/></svg>"
          rel="icon">
    <link href="https://npm.elemecdn.com/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{--primary:#7C3AED;--accent:#06B6D4;--bg-dark:#0A0A0A;--text-primary:#111827;--text-secondary:#374151;--text-main:#1f2937;--text-sub:#6b7280;--danger:#EF4444;--success:#059669;--warning:#D97706;--bg-body:#f3f4f6;--bg-panel:#ffffff;--bg-sidebar:rgba(255,255,255,0.95);--border:#e5e7eb;--input-bg:#f9fafb;--t-bg:#ffffff;--t-text:#000000;--t-time:#9ca3af;--t-source:#7C3AED;--t-cmd:#0891b2;--t-ip:#d946ef;--t-lvl-info:#059669;--t-lvl-warn:#D97706;--t-lvl-error:#DC2626;--t-border:#e5e7eb;--chart-line:#7C3AED;--chart-top:rgba(124,58,237,0.4);--chart-bottom:rgba(124,58,237,0.0);--chart-grid:#e5e7eb;--chart-text:#6b7280;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);--card-hover:0 10px 15px -3px rgba(0,0,0,0.1);--ease-smooth:cubic-bezier(0.4,0,0.2,1);--nav-height:60px;--ctx-bg:#ffffff;--ctx-border:#e5e7eb;--btn-primary-bg:var(--primary);--btn-primary-text:#ffffff}[data-theme="dark"]{--bg-body:#0A0A0A;--bg-panel:rgba(22,27,34,0.8);--bg-sidebar:rgba(13,17,23,0.95);--text-main:#e5e7eb;--text-sub:#9ca3af;--text-primary:#f3f4f6;--text-secondary:#d1d5db;--border:#30363d;--input-bg:#0d1117;--success:#238636;--danger:#f85149;--warning:#d29922;--t-bg:#0d1117;--t-text:#e6edf3;--t-time:#6e7681;--t-source:#A78BFA;--t-cmd:#58a6ff;--t-ip:#e879f9;--t-lvl-info:#3fb950;--t-lvl-warn:#d29922;--t-lvl-error:#f85149;--t-border:#30363d;--chart-line:#06B6D4;--chart-top:rgba(6,182,212,0.4);--chart-bottom:rgba(6,182,212,0.0);--chart-grid:#30363d;--chart-text:#8b949e;--shadow:0 8px 32px rgba(0,0,0,0.4);--card-hover:0 12px 40px rgba(0,0,0,0.6);--ctx-bg:#161b22;--ctx-border:#30363d;--btn-primary-bg:linear-gradient(135deg,var(--primary),var(--bg-dark))}*{margin:0;padding:0;box-sizing:border-box}a,button,input,.nav-btn,.b-nav-btn,.file-item,.dash-card,.port-card,.crumb,td{transition:background-color 0.2s,border-color 0.2s,color 0.2s,box-shadow 0.2s,transform 0.2s}body{font-family:'Segoe UI',sans-serif;background:var(--bg-body);color:var(--text-main);height:100vh;height:100dvh;overflow:hidden;display:flex}aside{width:240px;background:var(--bg-sidebar);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:1.5rem;z-index:20}.main-container{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column;width:100%}.mobile-header,.bottom-nav{display:none}@media(max-width:768px){aside{display:none!important}.main-container{width:100%;padding-top:60px;padding-bottom:0}.mobile-header{display:flex;justify-content:space-between;align-items:center;padding:0.8rem 1.5rem;background:var(--bg-sidebar);border-bottom:1px solid var(--border);z-index:20;position:fixed;top:0;left:0;width:100%;height:60px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}.bottom-nav{display:flex;position:fixed;bottom:0;left:0;width:100%;background:var(--bg-sidebar);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(--border);justify-content:space-around;padding:0.5rem 0;padding-bottom:calc(0.5rem + env(safe-area-inset-bottom));z-index:100;height:auto}.view{padding:1rem;padding-bottom:calc(80px + env(safe-area-inset-bottom))!important;display:block!important;overflow-y:auto!important;height:auto!important;position:absolute;inset:0}.modal{width:95%!important;max-width:none!important;max-height:85vh;overflow-y:auto;padding:1rem!important}.panel{flex:none!important;height:auto!important;min-height:auto!important;overflow:visible!important;margin-bottom:1.5rem}.table-container{min-height:100px;display:block}td,th{white-space:nowrap!important;font-size:0.85rem;padding:0.6rem 0.4rem}input,select,textarea{font-size:16px!important}.chart-wrapper{min-height:250px!important}.dash-grid{grid-template-columns:1fr}#view-terminal.view{display:flex!important;flex-direction:column;height:100dvh!important;overflow:hidden!important;padding-top:70px!important;padding-bottom:calc(60px + env(safe-area-inset-bottom))!important}#view-terminal .panel{flex:1!important;height:auto!important;display:flex!important;flex-direction:column;overflow:hidden!important;margin-bottom:0!important;max-height:none!important}#term-output{flex:1;overflow-y:auto!important;height:auto!important;min-height:0}.upload-fab{bottom:calc(70px + env(safe-area-inset-bottom))!important;right:15px!important}.paste-fab{bottom:calc(80px + env(safe-area-inset-bottom))!important}.upload-panel{bottom:calc(80px + env(safe-area-inset-bottom))!important}}.logo{font-size:1.4rem;font-weight:900;background:linear-gradient(90deg,var(--accent),var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;display:flex;align-items:center;gap:10px;letter-spacing:-0.5px}.status-badge{font-size:0.75rem;padding:4px 10px;border-radius:10px;background:var(--input-bg);color:var(--text-sub);margin-bottom:2rem;display:inline-flex;align-items:center;gap:6px;width:fit-content;border:1px solid var(--border)}.status-badge.connected{background:rgba(16,185,129,0.15);color:var(--success);border-color:var(--success)}.status-badge.disconnected{background:rgba(239,68,68,0.15);color:var(--danger);border-color:var(--danger)}.nav-menu{flex:1}.nav-btn{background:transparent;border:none;color:var(--text-sub);padding:0.8rem 1rem;text-align:left;cursor:pointer;width:100%;border-radius:8px;margin-bottom:0.5rem;font-size:0.95rem;display:flex;align-items:center;gap:12px}.nav-btn:hover{background:rgba(124,58,237,0.05);color:var(--text-main)}.nav-btn.active{background:linear-gradient(90deg,rgba(124,58,237,0.15),transparent);color:var(--accent);border-left:3px solid var(--accent);border-radius:4px 8px 8px 4px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.05)}.controls-wrapper{margin-top:auto;padding-top:1rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px}.ctrl-row{display:flex;gap:5px;background:var(--input-bg);padding:4px;border-radius:8px;border:1px solid var(--border)}.ctrl-btn{flex:1;border:none;background:transparent;color:var(--text-sub);padding:6px;border-radius:6px;cursor:pointer;font-size:0.9rem}.ctrl-btn:hover{color:var(--text-main)}.ctrl-btn.active{background:var(--bg-panel);color:var(--accent);box-shadow:0 2px 4px rgba(0,0,0,0.1)}.b-nav-btn{background:transparent;border:none;color:var(--text-sub);display:flex;flex-direction:column;align-items:center;gap:4px;font-size:0.7rem;padding:0.5rem;flex:1}.b-nav-btn i{font-size:1.2rem}.b-nav-btn.active{color:var(--accent);transform:translateY(-2px)}.view{position:absolute;inset:0;display:flex;flex-direction:column;padding:2rem;padding-bottom:40px;overflow-y:auto;opacity:0;visibility:hidden;transform:translateY(20px) scale(0.98);pointer-events:none;transition:0.4s var(--ease-smooth);z-index:1;-webkit-overflow-scrolling:touch}.view.active{opacity:1;visibility:visible;transform:translateY(0) scale(1);pointer-events:auto;z-index:10}.perf-container{display:flex;flex-direction:column;height:100%;overflow:hidden}@media(max-width:768px){.perf-container{overflow-y:auto;display:block}.perf-grid-bottom{display:flex;flex-direction:column}.port-panel{max-height:none}}.perf-grid-top{flex:0 0 auto;margin-bottom:1.5rem}.perf-grid-bottom{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;flex:1;min-height:0;overflow:hidden}.perf-label{display:flex;justify-content:space-between;margin-bottom:0.5rem;font-size:0.9rem;color:var(--text-sub);font-weight:500}.progress-track{height:16px;background:var(--input-bg);border-radius:8px;overflow:hidden;position:relative;border:1px solid var(--border);box-shadow:inset 0 1px 2px rgba(0,0,0,0.05)}.progress-fill{height:100%;background:var(--primary);transition:width 0.5s linear;position:absolute;top:0;left:0;opacity:0.3}.progress-sub{height:100%;background:var(--accent);transition:width 0.5s linear;position:absolute;top:0;left:0;opacity:1;border-right:2px solid rgba(255,255,255,0.5)}.port-panel{display:flex;flex-direction:column;height:100%;max-height:100%;overflow:hidden}.port-header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex:0 0 auto;flex-wrap:nowrap;gap:10px}.port-header-row .panel-title{white-space:nowrap;flex-shrink:0}.port-search-input{padding:5px 10px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-main);border-radius:6px;font-size:0.85rem;width:150px;outline:none;font-family:'Segoe UI',sans-serif;transition:border-color 0.2s}.port-search-input:focus{border-color:var(--accent)}.port-list-box{flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--input-bg);padding:8px;display:flex;flex-direction:column;gap:6px;min-height:0;box-shadow:inset 0 2px 4px rgba(0,0,0,0.02)}.port-card{padding:8px 12px;border:1px solid var(--border);border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-family:'Consolas',monospace;font-size:0.85rem;background:var(--bg-panel);transition:border-color 0.2s;cursor:default}.port-card:hover{border-color:var(--accent);background:var(--bg-panel)}.port-tag{padding:1px 6px;border-radius:4px;font-size:0.7rem;font-weight:bold;border:1px solid currentColor;opacity:0.8}.file-mgr-container{display:flex;flex-direction:column;height:100%;overflow:hidden}.file-toolbar{display:flex;gap:10px;margin-bottom:1rem;flex-wrap:wrap;align-items:center;flex:0 0 auto}.breadcrumb{display:flex;gap:5px;align-items:center;font-size:0.95rem;color:var(--text-sub);overflow-x:auto;padding-bottom:5px;font-family:'Consolas',monospace;white-space:nowrap}.crumb{cursor:pointer;padding:4px 8px;border-radius:6px;background:var(--input-bg);border:1px solid var(--border)}.crumb:hover{background:var(--bg-panel);color:var(--accent);border-color:var(--accent)}.file-scroll-area{flex:1;overflow-y:auto;min-height:0;padding-right:5px;position:relative}.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:1rem;padding-bottom:1rem}.file-item{display:flex;flex-direction:column;align-items:center;padding:1rem;border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;position:relative;background:var(--bg-panel);aspect-ratio:1/1;justify-content:center}.file-item:hover,.file-item.context-active{background:var(--input-bg);border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--card-hover)}.file-icon{font-size:2.5rem;margin-bottom:0.6rem;color:var(--text-sub);transition:color 0.2s}.file-item:hover .file-icon,.file-item.context-active .file-icon{color:var(--accent)}.file-name{font-size:0.8rem;word-break:break-word;line-height:1.3;max-height:2.6em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;color:var(--text-main)}.file-meta{font-size:0.7rem;color:var(--text-sub);margin-top:4px;font-family:monospace}.is-dir .file-icon{color:var(--warning)}.is-dir:hover .file-icon{color:#F59E0B}.file-dl-btn{position:absolute;top:5px;right:5px;font-size:0.9rem;color:var(--text-sub);opacity:0;padding:6px;background:var(--bg-panel);border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.1);z-index:2}.file-item:hover .file-dl-btn{opacity:1}.file-dl-btn:hover{color:var(--primary);transform:scale(1.1)}.file-check{position:absolute;top:5px;left:5px;width:18px;height:18px;z-index:2;cursor:pointer;opacity:0;accent-color:var(--accent)}.file-item:hover .file-check,.file-check:checked,.file-item.context-active .file-check{opacity:1}.file-item.drag-over{border:2px dashed var(--accent);background:rgba(6,182,212,0.1);transform:scale(1.05)}.drop-zone{border:2px dashed var(--border);border-radius:16px;padding:2rem;text-align:center;color:var(--text-sub);margin-bottom:1rem;transition:border-color 0.2s,background-color 0.2s;cursor:pointer}.drop-zone.dragover,.drop-zone:hover{border-color:var(--accent);background:rgba(6,182,212,0.05);color:var(--accent)}.drop-zone:active{transform:scale(0.98)}.btn-icon{background:var(--bg-panel);color:var(--text-sub);padding:0.5rem;width:36px;height:36px;border:1px solid var(--border);border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all 0.2s}.btn-icon:hover{color:var(--accent);border-color:var(--accent);background:var(--input-bg)}.btn-icon.active{background:var(--input-bg);color:var(--accent);border-color:var(--accent)}.toast-container{position:fixed;bottom:20px;right:20px;z-index:20000;display:flex;flex-direction:column;gap:10px;pointer-events:none}.toast{pointer-events:auto;background:var(--bg-panel);border-left:4px solid var(--accent);padding:1rem 1.5rem;border-radius:8px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.3);animation:slideIn 0.3s var(--ease-smooth);min-width:300px;font-size:0.95rem;display:flex;align-items:center;gap:12px;color:var(--text-main);border:1px solid var(--border)}.toast.success{border-left-color:var(--success)}.toast.danger{border-left-color:var(--danger)}.upload-fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--bg-panel);box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;align-items:center;justify-content:center;cursor:pointer;z-index:9000;transition:transform 0.2s,box-shadow 0.2s;border:1px solid var(--border)}.upload-fab:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(0,0,0,0.25)}.upload-fab i{font-size:1.2rem;color:var(--accent)}.fab-progress-ring{position:absolute;top:-4px;left:-4px;width:64px;height:64px;pointer-events:none;transform:rotate(-90deg)}.fab-circle{fill:none;stroke:var(--accent);stroke-width:3;stroke-dasharray:176;stroke-dashoffset:176;transition:stroke-dashoffset 0.3s}.upload-panel{position:fixed;bottom:90px;right:20px;width:350px;background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--card-hover);z-index:10000;display:none;flex-direction:column;overflow:hidden;animation:slideUp 0.3s var(--ease-smooth)}.upload-panel.show{display:flex}.up-header{background:var(--input-bg);padding:10px 15px;font-size:0.9rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}.up-list{max-height:300px;overflow-y:auto;display:flex;flex-direction:column;padding:5px}.up-item{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:4px;font-size:0.85rem;border-radius:6px;position:relative}.up-item:last-child{border-bottom:none}.up-item.active{background:rgba(124,58,237,0.05)}.up-item.done{order:-1;background:rgba(16,185,129,0.05)}.up-row-1{display:flex;justify-content:space-between;color:var(--text-main);word-break:break-all;align-items:center}.up-row-2{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:2px}.up-bar{height:100%;background:var(--accent);transition:width 0.2s}.up-meta{display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-sub);margin-top:2px}.up-cancel{color:var(--text-sub);cursor:pointer;padding:2px 5px;font-size:0.9rem}.up-cancel:hover{color:var(--danger)}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s}.modal-overlay.show{opacity:1}.modal{background:var(--bg-panel);width:90%;max-width:500px;border-radius:16px;display:flex;flex-direction:column;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);transform:scale(0.95);transition:transform 0.3s var(--ease-smooth);border:1px solid var(--border);padding:1.5rem;max-height:90vh}.modal.large{max-width:900px;height:85vh;padding:0}.modal-overlay.show .modal{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-shrink:0}.modal-title{font-size:1.2rem;font-weight:700;color:var(--text-main)}.modal-body{margin-bottom:1.5rem;color:var(--text-main);overflow-y:auto}.modal-footer{display:flex;justify-content:flex-end;gap:10px;flex-shrink:0}.editor-area{flex:1;background:var(--input-bg);color:var(--text-main);border:none;padding:1.5rem;font-family:'Consolas','Monaco',monospace;font-size:0.95rem;resize:none;outline:none;line-height:1.6}.editor-loading{position:absolute;inset:0;background:var(--bg-panel);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;gap:1rem}.panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.5rem;overflow:hidden;display:flex;flex-direction:column}#view-terminal{display:flex;flex-direction:column;height:100dvh}#view-terminal .panel{flex:1;min-height:0;margin-bottom:0}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}.panel-title{font-size:1.2rem;font-weight:700;color:var(--text-main);letter-spacing:0.5px}.dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.5rem;margin-bottom:1.5rem;flex:0 0 auto}.dash-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:16px;padding:1.5rem;display:flex;flex-direction:column;position:relative;overflow:hidden;box-shadow:var(--shadow);cursor:default}.dash-card:hover{transform:translateY(-5px);box-shadow:var(--card-hover);border-color:var(--accent)}.dash-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--primary)}.dash-card.card-1::before{background:var(--accent)}.dash-card.card-2::before{background:var(--success)}.dash-card.card-3::before{background:var(--warning)}.dash-icon{position:absolute;right:1.5rem;top:1.5rem;font-size:2.5rem;opacity:0.1;color:var(--text-main);transition:transform 0.3s}.dash-card:hover .dash-icon{transform:scale(1.1) rotate(5deg);opacity:0.15}.dash-label{font-size:0.9rem;color:var(--text-sub);font-weight:600;margin-bottom:0.5rem}.dash-value{font-size:2rem;font-weight:800;color:var(--text-main);font-family:'Consolas',monospace}.dash-sub{font-size:0.8rem;color:var(--text-sub);margin-top:auto;padding-top:0.5rem}.chart-wrapper{flex:2;min-height:300px;position:relative;display:flex;flex-direction:column}.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.chart-controls{display:flex;gap:5px;background:var(--input-bg);padding:2px;border-radius:6px;border:1px solid var(--border)}.chart-btn{border:none;background:transparent;color:var(--text-sub);padding:4px 8px;font-size:0.75rem;cursor:pointer;border-radius:4px}.chart-btn:hover{color:var(--text-main)}.chart-btn.active{background:var(--bg-panel);color:var(--accent);box-shadow:0 1px 2px rgba(0,0,0,0.1);font-weight:bold}.chart-container{flex:1;position:relative;width:100%;overflow:hidden}svg{width:100%;height:100%;overflow:visible}.chart-path{fill:none;stroke:var(--chart-line);stroke-width:2;stroke-linejoin:round;vector-effect:non-scaling-stroke}.chart-area{fill:url(#gradient);opacity:0.8}.chart-grid line{stroke:var(--chart-grid);stroke-width:1;stroke-dasharray:4}.chart-text{fill:var(--chart-text);font-size:11px;font-family:'Consolas',monospace;user-select:none}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1.5rem;margin-bottom:1.5rem}.form-group{display:flex;flex-direction:column;gap:0.6rem}label{font-size:0.9rem;color:var(--text-sub);font-weight:500}input[type="text"],input[type="number"]{background-color:var(--input-bg);border:1px solid var(--border);color:var(--text-main);padding:0.8rem 1rem;border-radius:8px;font-size:1rem;outline:none;transition:border-color 0.3s,box-shadow 0.3s;width:100%;font-family:'Consolas',sans-serif}.flex-input{flex:1}input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(6,182,212,0.15)}.btn{padding:0.6rem 1.2rem;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;color:white;justify-content:center;white-space:nowrap}.btn:active{transform:scale(0.96)}.btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);box-shadow:0 4px 15px rgba(124,58,237,0.3)}.btn-action{background:var(--input-bg);border:1px solid var(--border);color:var(--text-sub);padding:0.4rem 0.8rem;font-size:0.85rem;min-width:80px}.btn-action:hover{border-color:var(--accent);color:var(--accent)}.btn-danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--danger)}.btn-danger:hover{background:rgba(239,68,68,0.2)}.btn-sm{min-width:auto!important;padding:4px 8px!important;width:auto}.table-container{overflow-x:auto;flex:1;border:1px solid var(--border);border-radius:12px}table{width:100%;border-collapse:collapse;white-space:nowrap}th{text-align:left;padding:1rem;color:var(--accent);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-panel);z-index:5}td{padding:0.9rem 1rem;border-bottom:1px solid var(--border);color:var(--text-sub);font-size:0.95rem;vertical-align:middle}tr:hover td{background:rgba(124,58,237,0.05);color:var(--text-main)}#term-output{flex:1;background:var(--t-bg);color:var(--t-text);border:1px solid var(--t-border);border-radius:12px;padding:1rem;font-family:'Consolas','Monaco',monospace;font-size:0.9rem;overflow-y:auto;overflow-x:hidden;margin-bottom:1rem;white-space:pre-wrap;word-break:break-all;line-height:1.5}.log-entry{margin-bottom:2px}.l-time{color:var(--t-time);font-size:0.85rem;margin-right:6px}.l-lvl{font-weight:bold;margin-right:6px}.l-lvl.INFO{color:var(--t-lvl-info)}.l-lvl.WARN{color:var(--t-lvl-warn)}.l-lvl.ERROR{color:var(--t-lvl-error)}.l-src{color:var(--t-source);font-weight:600;margin-right:8px}.l-text{color:var(--t-text)}.l-cmd{color:var(--t-cmd);font-weight:bold;display:block;margin-top:6px;border-left:3px solid var(--t-cmd);padding-left:8px}.l-ip{color:var(--t-ip);font-weight:bold;background:rgba(217,70,239,0.1);padding:0 4px;border-radius:3px}.log-logo{color:var(--accent);font-weight:bold;line-height:1.1;white-space:pre;overflow-x:auto;margin-bottom:15px;font-family:'Consolas',monospace}.toggle-switch{position:relative;width:48px;height:26px;display:inline-block}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--text-sub);transition:.3s;border-radius:34px;opacity:0.3}.slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background-color:white;transition:.3s;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2)}input:checked+.slider{background-color:var(--success);opacity:1}input:checked+.slider:before{transform:translateX(22px)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--text-sub)}#error-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20000;text-align:center;color:#ffffff;font-family:'Segoe UI',sans-serif;display:none}.error-bg-effects{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.5}.error-grid-bg{position:absolute;width:100%;height:100%;background-image:linear-gradient(rgba(124,58,237,0.1) 1px,transparent 1px),linear-gradient(90deg,rgba(124,58,237,0.1) 1px,transparent 1px);background-size:50px 50px}.error-icon{font-size:6rem;margin-bottom:2rem;animation:pulse 2s infinite;color:#EF4444;filter:drop-shadow(0 0 20px rgba(239,68,68,0.4))}.error-title{font-size:2.5rem;font-weight:800;margin-bottom:1rem;letter-spacing:1px;color:#ffffff}.error-desc{color:#d1d5db;text-align:center;line-height:1.8;font-size:1.1rem;max-width:500px;padding:0 20px}.error-desc code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;font-family:monospace;color:#06B6D4}@keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:0.8}100%{transform:scale(1);opacity:1}}.context-menu{position:absolute;z-index:9999;background:var(--ctx-bg);border:1px solid var(--ctx-border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:180px;display:none;flex-direction:column;padding:5px;animation:fadeIn 0.1s ease}.context-item{padding:8px 12px;font-size:0.9rem;color:var(--text-main);cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:4px;transition:background 0.1s}.context-item:hover{background:var(--input-bg);color:var(--accent)}.context-item.danger:hover{background:rgba(239,68,68,0.1);color:var(--danger)}.context-sep{height:1px;background:var(--border);margin:4px 0}@keyframes fadeIn{from{opacity:0;transform:scale(0.98)}to{opacity:1;transform:scale(1)}}.move-browser{display:flex;flex-direction:column;height:100%;max-height:60vh}.move-list{flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px}.move-item{display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border)}.move-item:hover{background:var(--input-bg)}.move-item.selected{background:rgba(6,182,212,0.1);color:var(--accent)}.move-item:last-child{border-bottom:none}.paste-fab{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--bg-panel);padding:10px 20px;border-radius:20px;box-shadow:var(--card-hover);border:1px solid var(--border);display:none;gap:10px;align-items:center;z-index:9000;animation:slideUp 0.3s}.paste-fab.show{display:flex}.prop-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:0.9rem}.prop-k{color:var(--text-sub);font-weight:500}.prop-v{color:var(--text-main);font-family:monospace;max-width:250px;word-break:break-all;text-align:right}
    </style>
</head>
<body>
<div class="toast-container" id="toast-container"></div>
<div id="error-overlay">
    <div class="error-bg-effects">
        <div class="error-grid-bg"></div>
    </div>
    <div class="error-icon" id="error-icon"><i class="fas fa-shield-alt"></i></div>
    <div class="error-title" data-i18n="err_denied_title" id="error-title">403 Access Denied</div>
    <div class="error-desc" data-i18n="err_denied_desc" id="error-desc">Link expired or session conflict.</div>
</div>
<div class="modal-overlay" id="confirm-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" data-i18n="confirm_title">Confirmation</div>
        </div>
        <div class="modal-body" id="confirm-msg"></div>
        <div class="modal-footer">
            <button class="btn btn-action" data-i18n="btn_cancel" onclick="resolveConfirm(false)">Cancel</button>
            <button class="btn btn-primary" data-i18n="btn_confirm" onclick="resolveConfirm(true)">Confirm</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="conflict-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" data-i18n="conflict_title">File Exists</div>
        </div>
        <div class="modal-body" id="conflict-msg"></div>
        <div class="modal-footer">
            <button class="btn btn-action" data-i18n="btn_cancel" onclick="resolveConflict('cancel')">Cancel</button>
            <button class="btn btn-primary" data-i18n="btn_rename" onclick="resolveConflict('rename')">Rename</button>
            <button class="btn btn-danger" data-i18n="btn_overwrite" onclick="resolveConflict('overwrite')">Overwrite
            </button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="move-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" data-i18n="move_to_title">Move To</div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-action btn-sm" onclick="createFolderInMoveMode()" title="New Folder"><i
                        class="fas fa-folder-plus"></i></button>
                <button class="btn-icon" onclick="closeMoveModal()" style="width:24px;height:24px;font-size:0.8rem"><i
                        class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div style="display:flex;gap:5px;align-items:center;margin-bottom:5px">
                <button class="btn btn-action btn-sm" onclick="moveGoUp()"><i class="fas fa-arrow-up"></i> ..</button>
                <span id="move-current-path"
                      style="font-family:monospace;font-size:0.85rem;color:var(--text-sub)">/</span></div>
            <div class="move-browser">
                <div class="move-list" id="move-list">
                    <div style="padding:1rem;text-align:center"><span data-i18n="loading">Loading...</span></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" data-i18n="btn_move_here" onclick="confirmMove()">Move Here</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="props-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" data-i18n="ctx_props">Properties</div>
            <button class="btn-icon"
                    onclick="document.getElementById('props-modal').classList.remove('show');setTimeout(()=>document.getElementById('props-modal').style.display='none',300)"
                    style="width:24px;height:24px;font-size:0.8rem"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="props-body"></div>
    </div>
</div>
<div class="modal-overlay" id="input-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="input-title">Input</div>
        </div>
        <div class="modal-body"><input class="flex-input" id="input-value"
                                       onkeydown="if(event.key==='Enter')resolveInput(this.value)" type="text"></div>
        <div class="modal-footer">
            <button class="btn btn-action" data-i18n="btn_cancel" onclick="resolveInput(null)">Cancel</button>
            <button class="btn btn-primary" data-i18n="btn_confirm"
                    onclick="resolveInput(document.getElementById('input-value').value)">Confirm
            </button>
        </div>
    </div>
</div>
<div class="mobile-header">
    <div class="logo"><i class="fas fa-network-wired"></i> NeoProxy</div>
    <div class="status-badge disconnected" id="status-display-m"><i class="fas fa-circle-notch fa-spin"></i></div>
</div>
<aside>
    <div class="logo"><i class="fas fa-network-wired"></i> NeoProxy</div>
    <div class="status-badge disconnected" id="status-display"><i class="fas fa-circle-notch fa-spin"></i> <span
            data-i18n="connecting">Connecting...</span></div>
    <div class="nav-menu">
        <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"
                                                                           style="width:20px"></i> <span
                data-i18n="menu_dash">Dash</span></button>
        <button class="nav-btn" onclick="switchTab('performance')"><i class="fas fa-chart-line" style="width:20px"></i>
            <span data-i18n="m_perf">Performance</span></button>
        <button class="nav-btn" onclick="switchTab('files')"><i class="fas fa-folder" style="width:20px"></i> <span
                data-i18n="m_files">Files</span></button>
        <button class="nav-btn" onclick="switchTab('terminal')"><i class="fas fa-terminal" style="width:20px"></i> <span
                data-i18n="menu_term">Terminal</span></button>
        <button class="nav-btn" onclick="switchTab('keys')"><i class="fas fa-key" style="width:20px"></i> <span
                data-i18n="menu_keys">Keys</span></button>
        <button class="nav-btn" onclick="switchTab('clients')"><i class="fas fa-server" style="width:20px"></i> <span
                data-i18n="menu_clients">Online</span></button>
        <button class="nav-btn" onclick="switchTab('bans')"><i class="fas fa-ban" style="width:20px"></i> <span
                data-i18n="menu_bans">Bans</span></button>
    </div>
    <div class="controls-wrapper">
        <div class="ctrl-row">
            <button class="ctrl-btn" data-i18n-title="theme_light" onclick="applyTheme('light')" title="Light"><i
                    class="fas fa-sun"></i></button>
            <button class="ctrl-btn" data-i18n-title="theme_system" onclick="applyTheme('system')" title="System"><i
                    class="fas fa-desktop"></i></button>
            <button class="ctrl-btn" data-i18n-title="theme_dark" onclick="applyTheme('dark')" title="Dark"><i
                    class="fas fa-moon"></i></button>
        </div>
        <div class="ctrl-row">
            <button class="ctrl-btn active" data-i18n-title="lang_zh" onclick="setLang('zh')" title="中文">简</button>
            <button class="ctrl-btn" data-i18n-title="lang_en" onclick="setLang('en')" title="English">EN</button>
        </div>
    </div>
</aside>
<div class="main-container">
    <div class="view active" id="view-dashboard">
        <div class="dash-grid">
            <div class="dash-card card-1"><i class="fas fa-server dash-icon"></i>
                <div class="dash-label" data-i18n="dash_host_clients">Host Clients</div>
                <div class="dash-value" id="d-hc">0</div>
                <div class="dash-sub" data-i18n="dash_active_tunnels">Active Tunnels</div>
            </div>
            <div class="dash-card card-2"><i class="fas fa-users dash-icon"></i>
                <div class="dash-label" data-i18n="dash_ext_clients">External Users</div>
                <div class="dash-value" id="d-ec">0</div>
                <div class="dash-sub" data-i18n="dash_total_conn">Total Connections</div>
            </div>
            <div class="dash-card card-3"><i class="fas fa-network-wired dash-icon"></i>
                <div class="dash-label" data-i18n="dash_speed">Current Speed</div>
                <div class="dash-value" id="d-speed">0 B/s</div>
                <div class="dash-sub" data-i18n="dash_realtime">Real-time Throughput</div>
            </div>
        </div>
        <div class="panel chart-wrapper">
            <div class="chart-header">
                <div class="panel-title" data-i18n="dash_traffic_chart">Traffic Overview</div>
                <div class="chart-controls">
                    <button class="chart-btn active" data-i18n="chart_realtime" onclick="setChartRange(60)">Realtime
                    </button>
                    <button class="chart-btn" data-i18n="chart_5min" onclick="setChartRange(300)">5 Min</button>
                    <button class="chart-btn" data-i18n="chart_10min" onclick="setChartRange(600)">10 Min</button>
                </div>
            </div>
            <div class="chart-container">
                <svg id="traffic-chart" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="gradient" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="var(--chart-top)"/>
                            <stop offset="100%" stop-color="var(--chart-bottom)"/>
                        </linearGradient>
                    </defs>
                    <g id="chart-grid-lines"></g>
                    <path class="chart-area" d="" id="chart-area"></path>
                    <path class="chart-path" d="" id="chart-line"></path>
                    <g id="chart-labels"></g>
                </svg>
            </div>
        </div>
        <div class="panel" style="flex:0 auto;margin-top:1.5rem">
            <div class="panel-header">
                <div class="panel-title" data-i18n="dash_sys_info">System Info</div>
            </div>
            <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:1rem">
                <div><span data-i18n="lbl_ver" style="color:var(--text-sub)">Version:</span> <span id="d-ver"
                                                                                                   style="color:var(--text-main);font-weight:bold">-</span>
                </div>
                <div><span data-i18n="lbl_support" style="color:var(--text-sub)">Support:</span> <span id="d-sver"
                                                                                                       style="color:var(--text-main);font-weight:bold">-</span>
                </div>
                <div><span data-i18n="lbl_ports" style="color:var(--text-sub)">Ports:</span> <span id="d-ports"
                                                                                                   style="color:var(--text-main);font-weight:bold">-</span>
                </div>
            </div>
        </div>
    </div>
    <div class="view perf-container" id="view-performance">
        <div class="panel perf-grid-top">
            <div class="panel-header">
                <div class="panel-title" data-i18n="p_sys">System Info</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem">
                <div>
                    <div class="perf-label"><span data-i18n="p_cpu">CPU</span><span id="perf-cpu-val">0%</span></div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-cpu-sys" style="width:0%"></div>
                        <div class="progress-sub" id="bar-cpu-proc" style="width:0%;background:var(--accent)"></div>
                    </div>
                    <div id="cpu-model" style="font-size:0.75rem;color:var(--text-sub);margin-top:6px">-</div>
                </div>
                <div>
                    <div class="perf-label"><span data-i18n="p_mem">Memory</span><span id="perf-mem-val">0/0 GB</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-mem-sys"
                             style="width:0%;background:var(--warning);opacity:0.3"></div>
                        <div class="progress-sub" id="bar-mem-jvm" style="width:0%;background:var(--success)"></div>
                    </div>
                    <div id="mem-detail" style="font-size:0.75rem;color:var(--text-sub);margin-top:6px">JVM: -</div>
                </div>
                <div>
                    <div class="perf-label"><span data-i18n="p_disk">Disk</span><span id="perf-disk-val">0%</span></div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-disk"
                             style="width:0%;background:var(--danger);opacity:0.6"></div>
                    </div>
                    <div id="os-info" style="font-size:0.75rem;color:var(--text-sub);margin-top:6px">-</div>
                </div>
            </div>
        </div>
        <div class="perf-grid-bottom">
            <div class="panel port-panel">
                <div class="port-header-row">
                    <div class="panel-title" data-i18n="p_tcp">TCP Ports</div>
                    <input class="port-search-input" data-i18n-placeholder="p_search_tcp" id="search-tcp"
                           oninput="filterPorts('tcp')" placeholder="Filter TCP..." type="text"></div>
                <div class="port-list-box" id="tcp-list"></div>
            </div>
            <div class="panel port-panel">
                <div class="port-header-row">
                    <div class="panel-title" data-i18n="p_udp">UDP Ports</div>
                    <input class="port-search-input" data-i18n-placeholder="p_search_udp" id="search-udp"
                           oninput="filterPorts('udp')" placeholder="Filter UDP..." type="text"></div>
                <div class="port-list-box" id="udp-list"></div>
            </div>
        </div>
    </div>
    <div class="view" id="view-files">
        <div class="panel file-mgr-container">
            <div class="panel-header">
                <div class="panel-title" data-i18n="f_title">File Manager</div>
                <div style="display:flex;gap:5px">
                    <button class="btn btn-icon" data-i18n-title="btn_select_all" id="btn-select-all"
                            onclick="toggleSelectAll()" title="Select All"><i class="fas fa-check-square"></i></button>
                    <button class="btn btn-icon" data-i18n-title="btn_move" id="btn-move" onclick="openMoveSelector()"
                            title="Move"><i class="fas fa-dolly"></i></button>
                    <button class="btn btn-icon" data-i18n-title="btn_new_file" onclick="openCreateModal(false)"
                            title="New File"><i class="fas fa-file-medical"></i></button>
                    <button class="btn btn-icon" data-i18n-title="btn_new_folder" onclick="openCreateModal(true)"
                            title="New Folder"><i class="fas fa-folder-plus"></i></button>
                    <button class="btn btn-icon" data-i18n-title="btn_refresh" onclick="refreshFiles()" title="Refresh">
                        <i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
            <div class="file-toolbar">
                <div class="breadcrumb" id="file-crumb"><span class="crumb" onclick="loadDir('')">/</span></div>
            </div>
            <div class="file-scroll-area" id="file-area-root">
                <div class="drop-zone" id="drop-zone" onclick="triggerFileSelect()"><i class="fas fa-cloud-upload-alt"
                                                                                       style="font-size:2rem;margin-bottom:10px"></i><br><span
                        data-i18n="f_drop_click">点击此处 或 拖拽文件到此上传</span>
                    <div style="font-size:0.8rem;margin-top:5px;opacity:0.7">(<span
                            data-i18n="f_multi_support">支持多选，</span><a data-i18n="f_upload_folder" href="#"
                                                                           onclick="event.stopPropagation();triggerFolderSelect()"
                                                                           style="color:var(--accent);text-decoration:none;border-bottom:1px dashed var(--accent)">点击上传文件夹</a>)
                    </div>
                </div>
                <input id="upload-input-file" multiple onchange="handleUpload(this.files)" style="display:none"
                       type="file"><input id="upload-input-folder" onchange="handleUpload(this.files)"
                                          style="display:none" type="file" webkitdirectory>
                <div class="file-grid" id="file-grid"></div>
            </div>
        </div>
    </div>
    <div class="view" id="view-terminal">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" data-i18n="menu_term">System Terminal</div>
                <button class="btn btn-action" onclick="termOutput.innerHTML=''"><i class="fas fa-eraser"></i> <span
                        data-i18n="btn_clear">Clear</span></button>
            </div>
            <div id="term-output" style="flex:1"></div>
            <div style="display:flex;gap:10px;margin-top:10px;padding-bottom:env(safe-area-inset-bottom)"><input
                    autocomplete="off" class="flex-input" id="cmd-input" placeholder="..." type="text">
                <button class="btn btn-primary" data-i18n="btn_send" onclick="sendCmd()">Send</button>
            </div>
        </div>
    </div>
    <div class="view" id="view-keys">
        <div class="panel" style="flex:0 0 auto;margin-bottom:1.5rem">
            <div class="panel-header">
                <div class="panel-title" data-i18n="key_create_title" id="key-form-title">Create Key</div>
                <button class="btn btn-action" id="btn-cancel-edit" onclick="exitEditMode()" style="display:none"><i
                        class="fas fa-times"></i> <span data-i18n="btn_cancel">Cancel</span></button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label data-i18n="lbl_name">Name</label><input id="k-name"
                                                                                       placeholder="e.g. client-01"
                                                                                       type="text"></div>
                <div class="form-group"><label data-i18n="lbl_traffic">Traffic (MiB)</label><input id="k-bal"
                                                                                                   type="number"
                                                                                                   value="1024"></div>
                <div class="form-group"><label data-i18n="lbl_expire">Expire</label><input id="k-time" type="text">
                </div>
                <div class="form-group"><label data-i18n="lbl_port">Port</label><input id="k-port"
                                                                                       placeholder="8080 / 3000-3010"
                                                                                       type="text"></div>
                <div class="form-group"><label data-i18n="lbl_rate">Rate (Mbps)</label><input id="k-rate" type="number"
                                                                                              value="5"></div>
                <div class="form-group" style="justify-content:flex-end"><label
                        style="display:flex;align-items:center;gap:12px;cursor:pointer;color:var(--text-main);font-weight:500">
                    <div class="toggle-switch"><input id="k-web" type="checkbox"><span class="slider"></span></div>
                    WebHTML</label></div>
            </div>
            <div style="text-align:right">
                <button class="btn btn-primary" data-i18n="btn_create" id="btn-submit-key" onclick="submitKeyForm()">
                    Create
                </button>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" data-i18n="key_list">Key List</div>
                <button class="btn btn-primary" onclick="refreshKeys()"><i class="fas fa-sync-alt"></i> <span
                        data-i18n="btn_refresh">Refresh</span></button>
            </div>
            <div class="table-container" id="key-table-wrapper">
                <div style="padding:2rem;text-align:center;color:var(--text-sub)"><i
                        class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">Loading...</span></div>
            </div>
        </div>
    </div>
    <div class="view" id="view-clients">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" data-i18n="menu_clients">Online Clients</div>
                <button class="btn btn-primary" onclick="refreshClients()"><i class="fas fa-sync-alt"></i> <span
                        data-i18n="btn_refresh">Refresh</span></button>
            </div>
            <div class="table-container" id="client-table-wrapper">
                <div style="padding:2rem;text-align:center;color:var(--text-sub)"><i
                        class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">Loading...</span></div>
            </div>
        </div>
    </div>
    <div class="view" id="view-bans">
        <div class="panel" style="flex:0 0 auto;margin-bottom:1.5rem">
            <div class="panel-header">
                <div class="panel-title" data-i18n="ban_title">Manual Ban</div>
            </div>
            <div style="display:flex;gap:10px"><input class="flex-input" id="ban-ip-input" placeholder="IPv4 / IPv6"
                                                      type="text">
                <button class="btn btn-danger" onclick="doBanIp()"><i class="fas fa-ban"></i> <span data-i18n="btn_ban">Ban IP</span>
                </button>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title" data-i18n="menu_bans">Ban List</div>
                <button class="btn btn-primary" onclick="refreshBans()"><i class="fas fa-sync-alt"></i> <span
                        data-i18n="btn_refresh">Refresh</span></button>
            </div>
            <div class="table-container" id="ban-table-wrapper">
                <div style="padding:2rem;text-align:center;color:var(--text-sub)"><i
                        class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">Loading...</span></div>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="editor-modal">
    <div class="modal large">
        <div class="modal-header"
             style="padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <span class="panel-title" data-i18n="modal_edit_title" id="editor-filename"
                  style="font-size:1rem">Edit</span>
            <div style="display:flex;gap:10px">
                <button class="btn btn-primary" onclick="saveFile()"><i class="fas fa-save"></i> <span
                        data-i18n="btn_save">Save</span></button>
                <button class="btn btn-danger" onclick="closeEditor()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="editor-loading" id="editor-loading"><i class="fas fa-circle-notch fa-spin"
                                                           style="font-size:2.5rem;color:var(--accent)"></i>
            <div data-i18n="loading_content" style="margin-top:1rem;color:var(--text-sub)">Loading file content...</div>
        </div>
        <textarea class="editor-area" id="editor-content" spellcheck="false" style="display:none"></textarea></div>
</div>
<div class="modal-overlay" id="create-modal">
    <div class="modal">
        <div class="modal-header" style="margin-bottom:1rem">
            <div class="modal-title" data-i18n="modal_new_title" id="create-modal-title">New</div>
            <button class="btn btn-danger btn-icon"
                    onclick="document.getElementById('create-modal').classList.remove('show');setTimeout(()=>document.getElementById('create-modal').style.display='none',300)"
                    style="width:30px;height:30px;padding:0"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body"><input class="flex-input" data-i18n-placeholder="ph_name" id="new-file-name"
                                       onkeydown="if(event.key==='Enter')confirmCreate()" placeholder="Name"
                                       type="text"></div>
        <div class="modal-footer">
            <button class="btn btn-primary" data-i18n="btn_create" onclick="confirmCreate()">Create</button>
        </div>
    </div>
</div>
<nav class="bottom-nav">
    <button class="b-nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i><span
            data-i18n="menu_dash">Dash</span></button>
    <button class="b-nav-btn" onclick="switchTab('performance')"><i class="fas fa-chart-line"></i><span
            data-i18n="m_perf">Perf</span></button>
    <button class="b-nav-btn" onclick="switchTab('files')"><i class="fas fa-folder"></i><span
            data-i18n="m_files">Files</span></button>
    <button class="b-nav-btn" onclick="switchTab('terminal')"><i class="fas fa-terminal"></i><span
            data-i18n="menu_term">Term</span></button>
    <button class="b-nav-btn" onclick="switchTab('keys')"><i class="fas fa-key"></i><span
            data-i18n="menu_keys">Keys</span></button>
    <button class="b-nav-btn" onclick="switchTab('clients')"><i class="fas fa-server"></i><span
            data-i18n="menu_clients">Online</span></button>
    <button class="b-nav-btn" onclick="switchTab('bans')"><i class="fas fa-ban"></i><span
            data-i18n="menu_bans">Bans</span></button>
</nav>
<div class="upload-fab" onclick="toggleUploadPanel()">
    <svg class="fab-progress-ring">
        <circle class="fab-circle" cx="32" cy="32" r="28"/>
    </svg>
    <i class="fas fa-cloud-upload-alt"></i></div>
<div class="upload-panel" id="upload-panel">
    <div class="up-header"><span data-i18n="up_title" id="up-title-text">Upload Queue</span>
        <button class="btn-icon" onclick="toggleUploadPanel()" style="width:24px;height:24px;font-size:0.8rem"><i
                class="fas fa-times"></i></button>
    </div>
    <div class="up-list" id="up-list"></div>
</div>
<div class="paste-fab" id="paste-fab">
    <div style="display:flex;flex-direction:column"><span id="paste-count" style="font-weight:bold;font-size:0.9rem">1 Files</span><span
            id="paste-action" style="font-size:0.75rem;color:var(--text-sub)">Copy</span></div>
    <button class="btn btn-primary btn-sm" data-i18n="ctx_paste" onclick="pasteFiles()">Paste</button>
    <button class="btn btn-danger btn-sm" onclick="clearClipboard()"><i class="fas fa-times"></i></button>
</div>
<ul class="context-menu" id="context-menu"></ul>
<script>const PROTOCOL=window.location.protocol==='https:'?'wss':'ws';const HOST=window.location.host;const TOKEN=new URLSearchParams(window.location.search).get('token')||'';const WS_URL=`${PROTOCOL}://${HOST}/?token=${TOKEN}`;let ws;let curPath="";let moveModalPath="";let createModeDir=false;let curLang='zh';let currentTab='dashboard';let isEditMode=false;let originalKeyName="";let isExpectingTable=false;let tableTarget='';let chartRange=60;const trafficHistory=[];let lastTotalBalance=-1;let lastFetchTime=0;let heartbeatInterval,dashInterval;let rawPortData={tcp:[],udp:[]};let selectedFiles=new Set();let lastKeyData=null;let lastClientData=null;let lastBanData=null;let fileRequestTarget='view';let clipboardAction=null;let clipboardFiles=new Set();let currentFileList=[];const termOutput=document.getElementById('term-output');const cmdInput=document.getElementById('cmd-input');const banInput=document.getElementById('ban-ip-input');let confirmResolver=null;let conflictResolver=null;let inputResolver=null;let moveResolver=null;const systemThemeMedia=window.matchMedia("(prefers-color-scheme: dark)");const LANG={en:{app_title:"NeoProxy Admin",loading_app:"Loading NeoProxy...",connecting:"Connecting...",connected:"Connected",disconnected:"Disconnected",menu_dash:"Dashboard",menu_term:"Terminal",menu_keys:"Keys",menu_clients:"Clients",menu_bans:"Bans",btn_send:"Send",btn_clear:"Clear",btn_refresh:"Refresh",btn_create:"Create",btn_save:"Save",btn_cancel:"Cancel",btn_ban:"Ban IP",btn_confirm:"Confirm",btn_overwrite:"Overwrite",btn_rename:"Rename",key_create_title:"Create Key",key_edit_title:"Edit Key",key_list:"Key List",ban_title:"Manual Ban IP",loading:"Loading data...",no_data:"No Data",err_denied_title:"Access Denied",err_denied_desc:"Link expired or session conflict.<br>Please execute <code>webadmin</code> in the server console to get a new link.",th_op:"Action",th_ip:"IP",th_loc:"Location",th_isp:"ISP",th_name:"Name",th_bal:"Balance",th_time:"Expire",th_port:"Port",th_ext:"External Clients",th_rate:"Rate",st_enable:"Enabled",st_disable:"Disabled",st_on:"On",st_off:"Off",act_edit:"Edit",act_del:"Del",act_ban:"Ban",act_unban:"Unban",unknown:"Unknown",dash_host_clients:"Host Clients",dash_ext_clients:"External Users",dash_active_tunnels:"Active Tunnels",dash_total_conn:"Total Connections",dash_speed:"Current Speed",dash_realtime:"Real-time Throughput",dash_traffic_chart:"Traffic Overview (Global)",dash_sys_info:"System Info",chart_realtime:"Realtime",chart_5min:"5 Min",chart_10min:"10 Min",m_perf:"Performance",m_files:"Files",p_sys:"System Resources",p_tcp:"TCP Ports",p_udp:"UDP Ports",f_title:"File Manager",f_drop:"Drag files here to upload",btn_new:"New",p_search_tcp:"Filter TCP...",p_search_udp:"Filter UDP...",confirm_title:"Confirmation",confirm_del:"Are you sure you want to delete?",confirm_ban:"Are you sure you want to ban?",conflict_title:"File Exists",conflict_msg:"File already exists. Choose action:",toast_processing:"Processing...",toast_all_ok:"All files uploaded successfully",toast_partial:"Uploaded, some failed",toast_cancelled:"Upload cancelled",toast_uploading:"Uploading",input_move_title:"Move to (Relative Path)",input_move_ph:"e.g. folder/sub",btn_move:"Move",btn_select_all:"Select All",btn_new_file:"New File",btn_new_folder:"New Folder",f_drop_click:"Click here or Drag files to upload",f_multi_support:"Supports multiple files, ",f_upload_folder:"click to upload folder",lbl_ver:"Version:",lbl_support:"Support:",lbl_ports:"Ports:",lbl_name:"Name",lbl_traffic:"Traffic (MiB)",lbl_expire:"Expire",lbl_port:"Port",lbl_rate:"Rate (Mbps)",ph_name:"Name",p_cores:"Cores",p_used:"Used",p_used_jvm:"JVM Used: ",theme_light:"Light",theme_dark:"Dark",theme_system:"System",lang_zh:"中文",lang_en:"English",p_cpu:"CPU",p_mem:"Memory",p_disk:"Disk",msg_file_too_large:"File too large. Download?",msg_name_req:"Name required",msg_upload_failed:"Upload failed",modal_new_title:"New",modal_edit_title:"Edit",loading_content:"Loading file content...",err_net:"Network Error",err_cancel:"Cancelled",modal_new_file:"New File",modal_new_folder:"New Folder",up_title:"Upload Queue",up_complete:"Complete",up_fail:"Failed",up_wait:"Pending",msg_deleted:"Deleted: ",up_stats:"Uploaded: ",ctx_open:"Open",ctx_copy:"Copy",ctx_cut:"Cut",ctx_paste:"Paste",ctx_rename:"Rename",ctx_move:"Move To",ctx_download:"Download",ctx_delete:"Delete",btn_move_here:"Move Here",move_to_title:"Select Destination",msg_pasted:"Files pasted",move_no_subs:"No subfolders",ctx_props:"Properties",prop_path:"Path",prop_size:"Size",prop_type:"Type",prop_count:"Selected Count",prop_files:"Files",prop_folders:"Folders",prop_total_size:"Total Size",prop_time:"Modified",no_files:"No Files",msg_created:"Created: ",move_new_folder_ph:"Folder Name",msg_renamed:"Renamed successfully",msg_name_invalid:"Invalid filename",tip_remote_key:"Remote Key (Managed by NKM, Read Only)"},zh:{app_title:"NeoProxy 管理面板",loading_app:"NeoProxy 加载中...",connecting:"连接中...",connected:"已连接",disconnected:"未连接",menu_dash:"仪表盘",menu_term:"终端",menu_keys:"密钥",menu_clients:"在线",menu_bans:"封禁",btn_send:"发送",btn_clear:"清空",btn_refresh:"刷新",btn_create:"创建",btn_save:"保存",btn_cancel:"取消",btn_ban:"执行封禁",btn_confirm:"确认",btn_overwrite:"覆盖",btn_rename:"重命名",key_create_title:"创建新密钥",key_edit_title:"修改密钥",key_list:"密钥列表",ban_title:"手动封禁 IP",loading:"数据加载中...",no_data:"暂无数据",err_denied_title:"访问被拒绝",err_denied_desc:"链接已过期或会话冲突。<br>请在服务端控制台输入 <code>webadmin</code> 获取新的安全链接。",th_op:"操作",th_ip:"IP地址",th_loc:"地理位置",th_isp:"运营商",th_name:"名称",th_bal:"流量",th_time:"过期时间",th_port:"端口",th_ext:"外部客户端",th_rate:"速率",st_enable:"启用",st_disable:"禁用",st_on:"开启",st_off:"关闭",act_edit:"修改",act_del:"删除",act_ban:"封禁",act_unban:"解封",unknown:"未知",dash_host_clients:"穿透客户端",dash_ext_clients:"外部用户",dash_active_tunnels:"活跃隧道数",dash_total_conn:"当前总连接数",dash_speed:"实时速率",dash_realtime:"总吞吐量监测",dash_traffic_chart:"总流量趋势图",dash_sys_info:"系统基本信息",chart_realtime:"实时",chart_5min:"5 分钟",chart_10min:"10 分钟",m_perf:"性能",m_files:"文件",p_sys:"系统资源概览",p_tcp:"TCP 端口占用",p_udp:"UDP 端口占用",f_title:"文件管理",f_drop:"拖拽文件到此上传",btn_new:"新建",p_search_tcp:"搜索 TCP...",p_search_udp:"搜索 UDP...",confirm_title:"操作确认",confirm_del:"确定要删除吗？",confirm_ban:"确定要执行封禁吗？",conflict_title:"文件已存在",conflict_msg:"目标文件已存在，请选择操作：",toast_processing:"处理中...",toast_all_ok:"所有文件上传成功",toast_partial:"部分上传失败",toast_cancelled:"上传已取消",toast_uploading:"上传中",input_move_title:"移动到 (相对路径)",input_move_ph:"例如: folder/sub",btn_move:"移动",btn_select_all:"全选",btn_new_file:"新建文件",btn_new_folder:"新建文件夹",f_drop_click:"点击此处 或 拖拽文件到此上传",f_multi_support:"支持多选，",f_upload_folder:"点击上传文件夹",lbl_ver:"版本:",lbl_support:"支持:",lbl_ports:"端口:",lbl_name:"名称",lbl_traffic:"流量 (MiB)",lbl_expire:"过期时间",lbl_port:"端口",lbl_rate:"速率 (Mbps)",ph_name:"Name",p_cores:"核心",p_used:"已用",p_used_jvm:"JVM 已用: ",theme_light:"浅色模式",theme_dark:"深色模式",theme_system:"跟随系统",lang_zh:"中文",lang_en:"English",p_cpu:"CPU",p_mem:"内存",p_disk:"磁盘",msg_file_too_large:"文件过大，是否下载？",msg_name_req:"名称不能为空",msg_upload_failed:"上传失败",modal_new_title:"新建",modal_edit_title:"编辑",loading_content:"正在加载文件内容...",err_net:"网络错误",err_cancel:"已取消",modal_new_file:"新建文件",modal_new_folder:"新建文件夹",up_title:"上传队列",up_complete:"完成",up_fail:"失败",up_wait:"等待中",msg_deleted:"已删除: ",up_stats:"已传: ",ctx_open:"打开",ctx_copy:"复制",ctx_cut:"剪切",ctx_paste:"粘贴",ctx_rename:"重命名",ctx_move:"移动到",ctx_download:"下载",ctx_delete:"删除",btn_move_here:"移动到此",move_to_title:"选择目标文件夹",msg_pasted:"文件已粘贴",move_no_subs:"无子文件夹",ctx_props:"属性",prop_path:"路径",prop_size:"大小",prop_type:"类型",prop_count:"已选数量",prop_files:"文件数",prop_folders:"文件夹数",prop_total_size:"总大小",prop_time:"修改时间",no_files:"暂无文件",msg_created:"已创建: ",move_new_folder_ph:"文件夹名称",msg_renamed:"重命名成功",msg_name_invalid:"文件名包含非法字符",tip_remote_key:"远程密钥 (由 NKM 托管，只读)"}};function init(){const savedTheme=localStorage.getItem('theme')||'system';applyTheme(savedTheme);systemThemeMedia.addListener((e)=>{if(localStorage.getItem('theme')==='system'){applyTheme('system')}});setLang(navigator.language.startsWith('zh')?'zh':'en');connectWs();const dz=document.getElementById('drop-zone');if(dz){dz.ondragover=e=>{e.preventDefault();dz.classList.add('dragover')};dz.ondragleave=()=>dz.classList.remove('dragover');dz.ondrop=e=>{e.preventDefault();dz.classList.remove('dragover');handleDrop(e)}}if(typeof initDatePicker==='function')initDatePicker();window.addEventListener('resize',()=>{requestAnimationFrame(drawChart)});cmdInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendCmd()});banInput.addEventListener('keydown',e=>{if(e.key==='Enter')doBanIp()});document.addEventListener('click',e=>{document.getElementById('context-menu').style.display='none'});document.getElementById('file-area-root').addEventListener('contextmenu',e=>{if(e.target.closest('.file-item'))return;e.preventDefault();showContextMenu(e,null)})}function setLang(l){curLang=l;for(let k in LANG[l]){const els=document.querySelectorAll(`[data-i18n="${k}"]`);els.forEach(el=>el.innerHTML=LANG[l][k]);const elsP=document.querySelectorAll(`[data-i18n-placeholder="${k}"]`);elsP.forEach(el=>el.placeholder=LANG[l][k]);const elsT=document.querySelectorAll(`[data-i18n-title="${k}"]`);elsT.forEach(el=>el.title=LANG[l][k])}document.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));const langBtn=document.querySelector(`.ctrl-btn[onclick="setLang('${l}')"]`);if(langBtn)langBtn.classList.add('active');if(currentTab==='keys'&&lastKeyData)renderKeyTable(lastKeyData);else if(currentTab==='clients'&&lastClientData)renderClientTable(lastClientData);else if(currentTab==='bans'&&lastBanData)renderBanTable(lastBanData);updateHeader()}function applyTheme(mode){localStorage.setItem('theme',mode);document.querySelectorAll('.ctrl-btn').forEach(b=>{b.classList.remove('active');const onclick=b.getAttribute('onclick');if(onclick&&onclick.includes(`'${mode}'`))b.classList.add('active')});let resolved=mode;if(mode==='system')resolved=systemThemeMedia.matches?'dark':'light';document.documentElement.setAttribute('data-theme',resolved)}function connectWs(){ws=new WebSocket(WS_URL);ws.onopen=()=>{updateStatus(true);if(heartbeatInterval)clearInterval(heartbeatInterval);heartbeatInterval=setInterval(()=>{if(ws.readyState===1)ws.send("PING")},5000);startDashPolling();if(currentTab==='files')loadDir("");refreshCurrentTab()};ws.onclose=(event)=>{updateStatus(false);if(event.code===409||event.code===1008||event.code===4403||event.code===1006)lockDown();else setTimeout(connectWs,3000)};ws.onmessage=(e)=>{try{const msg=JSON.parse(e.data);if(msg.type==='log'){logRaw(msg.payload);if(isExpectingTable)checkAndParseTableData(msg.payload)}else if(msg.type==='logo')logLogo(msg.payload);else if(msg.type==='cmd_result')handleTableData(msg.payload);else if(msg.type==='dashboard_data')updateDashboard(JSON.parse(msg.payload));else if(msg.type==='action'&&msg.payload==='refresh_clients')refreshClients();else if(msg.type==='perf_sys')updatePerf(msg.payload);else if(msg.type==='perf_ports')updatePorts(msg.payload);else if(msg.type==='file_list')handleFileList(msg.payload,msg.path);else if(msg.type==='file_content')showEditorContent(msg.payload);else if(msg.type==='file_too_large')confirmDownload(msg.path);else if(msg.type==='toast'){let text=msg.payload;if(text.startsWith("Deleted: "))text=t('msg_deleted')+text.substring(9);else if(text.startsWith("Created: "))text=t('msg_created')+text.substring(9);else if(text.startsWith("Moved: "))text=text;showToast(text,'success')}else if(msg.type==='error')showToast(msg.payload,'danger');else if(msg.type==='action'&&msg.payload==='refresh_files'){if(fileRequestTarget==='view')refreshFiles()}}catch(err){}}}function updateStatus(connected){const el=document.getElementById('status-display');const elM=document.getElementById('status-display-m');if(connected){el.classList.remove('disconnected');el.classList.add('connected');el.innerHTML=`<i class="fas fa-link"></i> ${t('connected')}`;elM.className='status-badge connected';elM.innerHTML='<i class="fas fa-check"></i>'}else{el.classList.remove('connected');el.classList.add('disconnected');el.innerHTML=`<i class="fas fa-unlink"></i> ${t('disconnected')}`;elM.className='status-badge disconnected';elM.innerHTML='<i class="fas fa-times"></i>'}}function lockDown(){if(ws)ws.close();document.getElementById('error-overlay').style.display='flex'}function switchTab(id){currentTab=id;document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));document.getElementById('view-'+id).classList.add('active');document.querySelectorAll('.nav-btn, .b-nav-btn').forEach(b=>b.classList.remove('active'));const sel=`.nav-btn[onclick*="${id}"], .b-nav-btn[onclick*="${id}"]`;document.querySelectorAll(sel).forEach(b=>b.classList.add('active'));const fab=document.querySelector('.upload-fab');if(fab)fab.style.display=(id==='files')?'flex':'none';if(id!=='files')document.getElementById('upload-panel').classList.remove('show');if(ws&&ws.readyState===1){refreshCurrentTab();if(id==='dashboard')requestAnimationFrame(drawChart);if(id==='files')refreshFiles()}}function refreshCurrentTab(){if(currentTab==='keys')refreshKeys();else if(currentTab==='clients')refreshClients();else if(currentTab==='bans')refreshBans()}function startDashPolling(){if(dashInterval)clearInterval(dashInterval);dashInterval=setInterval(()=>{if(ws&&ws.readyState===1){ws.send("#GET_DASHBOARD");if(document.getElementById('view-performance').classList.contains('active')){ws.send("#GET_PERFORMANCE");ws.send("#GET_PORTS")}}},500)}function updatePerf(data){setBar('bar-cpu-sys',data.cpu.sys*100);setBar('bar-cpu-proc',data.cpu.proc*100);document.getElementById('perf-cpu-val').innerText=(data.cpu.sys*100).toFixed(1)+'% (Proc: '+(data.cpu.proc*100).toFixed(1)+'%)';document.getElementById('cpu-model').innerText=data.cpu.cores+" "+t('p_cores')+" | "+data.cpu.model;const usedGB=(data.mem.used/1073741824).toFixed(1);const totalGB=(data.mem.total/1073741824).toFixed(1);setBar('bar-mem-sys',(data.mem.used/data.mem.total)*100);setBar('bar-mem-jvm',(data.mem.jvm/data.mem.total)*100);document.getElementById('perf-mem-val').innerText=usedGB+"/"+totalGB+" GB";document.getElementById('mem-detail').innerText=t('p_used_jvm')+(data.mem.jvm/1048576).toFixed(0)+" MB";setBar('bar-disk',(data.disk.used/data.disk.total)*100);document.getElementById('perf-disk-val').innerText=(data.disk.used/1073741824).toFixed(0)+"GB "+t('p_used');document.getElementById('os-info').innerText=data.os}function setBar(id,val){const el=document.getElementById(id);if(el)el.style.width=Math.min(100,Math.max(0,val))+'%'}function updatePorts(data){rawPortData=data;filterPorts('tcp');filterPorts('udp')}function filterPorts(type){const searchInput=document.getElementById(`search-${type}`);const query=searchInput?searchInput.value.toLowerCase():"";const listContainer=document.getElementById(`${type}-list`);if(!listContainer)return;const rawList=rawPortData[type]||[];const filtered=rawList.filter(p=>p.toLowerCase().includes(query));let html="";if(filtered.length===0)html=`<div style="text-align:center;color:var(--text-sub);padding:10px;font-size:0.8rem;"><span data-i18n="no_data">${t('no_data')}</span></div>`;else{const color=type==='tcp'?'var(--accent)':'var(--warning)';const label=type.toUpperCase();html=filtered.map(p=>`<div class="port-card"><span class="port-addr">${escapeHtml(p)}</span><span class="port-tag" style="color:${color};border-color:${color}">${label}</span></div>`).join('')}if(listContainer.innerHTML!==html)listContainer.innerHTML=html}function escapeHtml(text){if(!text)return text;return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/"/g,"&#039;")}function loadDir(path){fileRequestTarget='view';curPath=path;selectedFiles.clear();updateMoveBtn();document.getElementById('file-grid').innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-sub)"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">${t('loading')}</span></div>`;ws.send("#GET_FILES:"+path)}function refreshFiles(){loadDir(curPath)}function handleFileList(list,path){list=list||[];if(fileRequestTarget==='view'){currentFileList=list;renderFiles(list,path)}else renderMoveList(list,path)}let dragSrcItem=null;let dragGhost=null;let dragTimer=null;function renderFiles(list,path){curPath=path;const parts=path.split(/[/\\]/);let bcHtml=`<span class="crumb" onclick="loadDir('')"><i class="fas fa-home"></i></span>`;let buildPath="";parts.forEach(p=>{if(p){buildPath+=(buildPath?"/":"")+p;bcHtml+=` / <span class="crumb" onclick="loadDir('${buildPath}')">${p}</span>`}});document.getElementById('file-crumb').innerHTML=bcHtml;list.sort((a,b)=>{if(a.isDir&&!b.isDir)return-1;if(!a.isDir&&b.isDir)return 1;return a.name.localeCompare(b.name)});const grid=document.getElementById('file-grid');const visible=list.filter(f=>f.name!=='..');if(visible.length===0){grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-sub)"><span data-i18n="no_files">${t('no_files')}</span></div>`;updateMoveBtn();return}grid.innerHTML=list.map(f=>{if(f.name==='..')return'';const icon=getFileIcon(f.name,f.isDir);const isImg=isImage(f.name);const token=new URLSearchParams(location.search).get('token');const relPath=(path?path+"/":"")+f.name;let clickAction=f.isDir?`loadDir('${relPath}')`:(isImg?`window.open('/download?file=${encodeURIComponent(relPath)}&token=${token}', '_blank')`:`reqEdit('${relPath}')`);const delAction=`event.stopPropagation(); reqDeleteFile('${relPath}', '${f.name}')`;const dlLink=`/download?file=${encodeURIComponent(relPath)}&token=${token}`;const dropAttr=f.isDir?`ondrop="handleFolderDrop(event, '${f.name}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"`:'';return`<div class="file-item ${f.isDir?'is-dir':''}" draggable="true" ondragstart="handleDragStart(event, '${f.name}')" ${dropAttr} ontouchstart="handleTouchStart(event, '${f.name}')" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)" onclick="${clickAction}" oncontextmenu="event.preventDefault(); showContextMenu(event, {name:'${f.name}', isDir:${f.isDir}, path:'${relPath}', size:${f.size}, time:${f.time}})">
<input type="checkbox" class="file-check" onchange="toggleSelect('${f.name}', event)" onclick="event.stopPropagation()" ${selectedFiles.has(f.name)?'checked':''}><i class="fas ${icon} file-icon"></i><div class="file-name">${escapeHtml(f.name)}</div><div class="file-meta">${f.isDir?'-':fmtSize(f.size)}</div><a href="${dlLink}" target="_blank" class="file-dl-btn" onclick="event.stopPropagation()"><i class="fas fa-download"></i></a><i class="fas fa-trash" style="position:absolute;bottom:5px;right:5px;color:var(--danger);opacity:0.5;font-size:0.8rem;padding:5px" onclick="${delAction}"></i></div>`}).join('');updateMoveBtn()}function handleDragStart(e,name){e.stopPropagation();if(!selectedFiles.has(name)){selectedFiles.clear();selectedFiles.add(name);updateMoveBtn()}e.dataTransfer.setData("text/plain",name);e.dataTransfer.effectAllowed="move"}function handleDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over')}function handleDragLeave(e){e.currentTarget.classList.remove('drag-over')}function handleFolderDrop(e,targetFolder){e.preventDefault();e.stopPropagation();e.currentTarget.classList.remove('drag-over');reqMoveTo(targetFolder)}function handleTouchStart(e,name){if(e.target.closest('.file-check')||e.target.closest('.file-dl-btn')||e.target.closest('.fa-trash'))return;dragTimer=setTimeout(()=>{dragSrcItem={name:name,x:e.touches[0].clientX,y:e.touches[0].clientY};if(!selectedFiles.has(name)){selectedFiles.clear();selectedFiles.add(name);updateMoveBtn()}createDragGhost(e.touches[0].clientX,e.touches[0].clientY);navigator.vibrate&&navigator.vibrate(50)},300)}function handleTouchMove(e){if(dragSrcItem){e.preventDefault();moveDragGhost(e.touches[0].clientX,e.touches[0].clientY)}}function handleTouchEnd(e){clearTimeout(dragTimer);removeDragGhost();if(dragSrcItem){const touch=e.changedTouches[0];const elem=document.elementFromPoint(touch.clientX,touch.clientY);if(elem){const folderItem=elem.closest('.is-dir');if(folderItem){const targetName=folderItem.querySelector('.file-name').innerText;if(targetName&&targetName!==dragSrcItem.name){reqMoveTo(targetName)}}}}dragSrcItem=null}function createDragGhost(x,y){removeDragGhost();dragGhost=document.createElement('div');dragGhost.style.position='fixed';dragGhost.style.left=x+'px';dragGhost.style.top=y+'px';dragGhost.style.padding='10px';dragGhost.style.background='var(--accent)';dragGhost.style.color='white';dragGhost.style.borderRadius='8px';dragGhost.style.pointerEvents='none';dragGhost.style.zIndex='10000';dragGhost.style.opacity='0.8';dragGhost.innerHTML=`<i class="fas fa-file"></i> ${selectedFiles.size}`;document.body.appendChild(dragGhost)}function moveDragGhost(x,y){if(dragGhost){dragGhost.style.left=x+'px';dragGhost.style.top=y+'px'}}function removeDragGhost(){if(dragGhost){dragGhost.remove();dragGhost=null}}async function reqMoveTo(targetFolder){if(selectedFiles.size===0)return;let payload="#MOVE_FILES:"+targetFolder;selectedFiles.forEach(f=>payload+="|"+(curPath?curPath+"/":"")+f);ws.send(payload);selectedFiles.clear();updateMoveBtn()}function toggleSelect(name,e){if(selectedFiles.has(name))selectedFiles.delete(name);else selectedFiles.add(name);updateMoveBtn()}function toggleSelectAll(){const checkboxes=document.querySelectorAll('.file-check');if(checkboxes.length===0)return;const allChecked=Array.from(checkboxes).every(c=>c.checked);checkboxes.forEach(c=>{if(!allChecked&&!c.checked)c.click();else if(allChecked&&c.checked)c.click()})}function updateMoveBtn(){const btn=document.getElementById('btn-move');if(selectedFiles.size>0){btn.classList.add('active');btn.disabled=false}else{btn.classList.remove('active');btn.disabled=true}}function isImage(name){return/\.(jpg|jpeg|png|gif|webp|svg|ico|bmp)$/i.test(name)}function getFileIcon(name,isDir){if(isDir)return'fa-folder';if(isImage(name))return'fa-image';if(name.endsWith('.jar'))return'fa-cube';if(name.endsWith('.zip')||name.endsWith('.rar')||name.endsWith('.7z')||name.endsWith('.tar')||name.endsWith('.gz'))return'fa-file-archive';if(name.endsWith('.js')||name.endsWith('.html')||name.endsWith('.css')||name.endsWith('.json')||name.endsWith('.xml'))return'fa-file-code';if(name.endsWith('.txt')||name.endsWith('.cfg')||name.endsWith('.properties')||name.endsWith('.log'))return'fa-file-alt';return'fa-file'}let currentEditPath="";function reqEdit(path){currentEditPath=path;document.getElementById('editor-modal').classList.add('show');document.getElementById('editor-modal').style.display='flex';document.getElementById('editor-loading').style.display='flex';document.getElementById('editor-content').style.display='none';document.getElementById('editor-filename').innerText=path;ws.send("#READ_FILE:"+path)}function confirmDownload(path){closeEditor();openConfirmModal(t('msg_file_too_large')).then(yes=>{if(yes){const token=new URLSearchParams(location.search).get('token');window.open(`/download?file=${encodeURIComponent(path)}&token=${token}`,'_blank')}})}function showEditorContent(content){document.getElementById('editor-loading').style.display='none';const ta=document.getElementById('editor-content');ta.style.display='block';ta.value=content}function saveFile(){const content=document.getElementById('editor-content').value;ws.send("#SAVE_FILE:"+currentEditPath+"|"+content)}function closeEditor(){document.getElementById('editor-modal').classList.remove('show');setTimeout(()=>document.getElementById('editor-modal').style.display='none',300)}function openCreateModal(isDir){createModeDir=isDir;document.getElementById('create-modal-title').innerText=isDir?t('modal_new_folder'):t('modal_new_file');document.getElementById('create-modal').style.display='flex';document.getElementById('create-modal').classList.add('show');document.getElementById('new-file-name').value="";document.getElementById('new-file-name').focus()}function confirmCreate(){const name=document.getElementById('new-file-name').value.trim();if(name){ws.send((createModeDir?"#CREATE_DIR:":"#CREATE_FILE:")+curPath+"|"+name);document.getElementById('create-modal').classList.remove('show');setTimeout(()=>document.getElementById('create-modal').style.display='none',300)}}function openConfirmModal(msg){return new Promise(resolve=>{confirmResolver=resolve;document.getElementById('confirm-msg').innerText=msg;document.getElementById('confirm-modal').style.display='flex';document.getElementById('confirm-modal').classList.add('show')})}function resolveConfirm(result){document.getElementById('confirm-modal').classList.remove('show');setTimeout(()=>document.getElementById('confirm-modal').style.display='none',300);if(confirmResolver)confirmResolver(result)}function openConflictModal(filename){return new Promise(resolve=>{conflictResolver=resolve;document.getElementById('conflict-msg').innerText=`${t('conflict_msg')} "${filename}"`;document.getElementById('conflict-modal').style.display='flex';document.getElementById('conflict-modal').classList.add('show')})}function resolveConflict(action){document.getElementById('conflict-modal').classList.remove('show');setTimeout(()=>document.getElementById('conflict-modal').style.display='none',300);if(conflictResolver)conflictResolver(action)}function openInputModal(title,placeholder,defaultValue=""){return new Promise(resolve=>{inputResolver=resolve;document.getElementById('input-title').innerText=title;document.getElementById('input-value').placeholder=placeholder;document.getElementById('input-value').value=defaultValue;document.getElementById('input-modal').style.display='flex';document.getElementById('input-modal').classList.add('show');const input=document.getElementById('input-value');input.focus();if(defaultValue)input.select()})}function resolveInput(val){document.getElementById('input-modal').classList.remove('show');setTimeout(()=>document.getElementById('input-modal').style.display='none',300);if(inputResolver)inputResolver(val)}async function reqDeleteFile(path,name){if(await openConfirmModal(t('confirm_del')+` (${name})`)){ws.send('#DELETE_FILE:'+path)}}async function reqDeleteKey(name){if(await openConfirmModal(t('confirm_del')+` (${name})`)){ws.send('key del '+name);setTimeout(refreshKeys,500)}}async function reqBanIp(ip){if(await openConfirmModal(t('confirm_ban')+` (${ip})`)){ws.send('ban '+ip);setTimeout(refreshBans,500)}}function triggerFileSelect(){document.getElementById('upload-input-file').value=null;document.getElementById('upload-input-file').click()}function triggerFolderSelect(){document.getElementById('upload-input-folder').value=null;document.getElementById('upload-input-folder').click()}let uploadQueue=[];let activeUploads=0;const MAX_CONCURRENT=3;let totalFiles=0;let finishedFiles=0;const uploadControllers=new Map();function toggleUploadPanel(){const p=document.getElementById('upload-panel');p.classList.toggle('show')}function updateHeader(){const txt=document.getElementById('up-title-text');if(txt)txt.innerText=`${t('up_stats')} ${finishedFiles} / ${totalFiles-(finishedFiles)}`;const circle=document.querySelector('.fab-circle');if(circle){const r=28;const c=2*Math.PI*r;const pct=totalFiles>0?finishedFiles/totalFiles:0;circle.style.strokeDashoffset=c*(1-pct)}}function addUploadItem(id,name,size){const list=document.getElementById('up-list');const d=document.createElement('div');d.className='up-item';d.id='up-item-'+id;d.innerHTML=`<div class="up-row-1"><span><i class="fas fa-file"></i> ${name}</span><span id="up-pct-${id}">0%</span></div><div class="up-row-2"><div class="up-bar" id="up-bar-${id}" style="width:0%"></div></div><div class="up-meta" id="up-meta-${id}"><span id="up-stat-${id}">${t('up_wait')}</span><span id="up-size-${id}">${fmtSize(size)} <i class="fas fa-times up-cancel" onclick="abortUpload('${id}')"></i></span></div>`;list.appendChild(d);return d}function markItemDone(id){const item=document.getElementById('up-item-'+id);if(item){item.classList.add('done');const list=document.getElementById('up-list');list.insertBefore(item,list.firstChild);const cancelBtn=item.querySelector('.up-cancel');if(cancelBtn)cancelBtn.remove()}}function updateItemProgress(id,pct,status,speed,uploaded,total){const bar=document.getElementById('up-bar-'+id);const pEl=document.getElementById('up-pct-'+id);const sEl=document.getElementById('up-stat-'+id);const szEl=document.getElementById('up-size-'+id);if(bar)bar.style.width=pct+'%';if(pEl)pEl.innerText=pct.toFixed(1)+'%';if(sEl){sEl.innerText=status;if(speed)sEl.innerText+=` (${speed})`}if(szEl&&uploaded&&total)szEl.innerText=`${uploaded} / ${total}`}function uploadNext(){if(uploadQueue.length===0)return;while(activeUploads<MAX_CONCURRENT&&uploadQueue.length>0){const task=uploadQueue.shift();processUpload(task)}}async function processUpload(task){const{file,id,relPath}=task;activeUploads++;const token=new URLSearchParams(location.search).get('token');const baseUrl=window.location.origin;let finalName=file.name;try{let uploadPath=curPath;if(relPath){const parts=relPath.split('/');parts.pop();if(parts.length>0){const sub=parts.join('/');uploadPath=curPath?(curPath+"/"+sub):sub}}const checkUrl=new URL(baseUrl+"/check_exists");checkUrl.searchParams.append("path",uploadPath);checkUrl.searchParams.append("filename",finalName);if(token)checkUrl.searchParams.append("token",token);let checkOk=false;try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),3000);const checkRes=await fetch(checkUrl,{signal:controller.signal});clearTimeout(timeoutId);if(checkRes.ok&&(await checkRes.text())==="true")checkOk=true}catch(e){}if(checkOk){const action=await openConflictModal(finalName);if(action==='cancel'){activeUploads--;updateItemProgress(id,0,t('err_cancel'));finishedFiles++;updateHeader();uploadNext();return}if(action==='rename'){finalName=Date.now()+"_"+finalName}}const url=new URL(baseUrl+"/upload");url.searchParams.append("path",uploadPath);url.searchParams.append("filename",finalName);if(token)url.searchParams.append("token",token);await uploadXHR(file,url.toString(),id);finishedFiles++;updateHeader();markItemDone(id)}catch(e){if(e.name==='AbortError')updateItemProgress(id,0,t('err_cancel'));else updateItemProgress(id,0,t('up_fail'))}finally{activeUploads--;uploadControllers.delete(id);uploadNext()}}function uploadXHR(file,url,id){return new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest();uploadControllers.set(id,xhr);let lastLoaded=0;let lastTime=Date.now();xhr.open('POST',url,true);xhr.upload.onprogress=(e)=>{if(e.lengthComputable){const now=Date.now();const dt=(now-lastTime)/1000;if(dt>=0.5){const speed=(e.loaded-lastLoaded)/dt;updateItemProgress(id,(e.loaded/e.total)*100,t('toast_uploading'),fmtSize(speed)+'/s',fmtSize(e.loaded),fmtSize(e.total));lastLoaded=e.loaded;lastTime=now}}};xhr.onload=()=>{if(xhr.status>=200&&xhr.status<300){updateItemProgress(id,100,t('up_complete'));resolve()}else reject(new Error('HTTP '+xhr.status))};xhr.onerror=()=>reject(new Error('Network Error'));xhr.onabort=()=>reject(new Error('AbortError'));xhr.send(file)})}function abortUpload(id){const xhr=uploadControllers.get(id);if(xhr){xhr.abort();uploadControllers.delete(id);const item=document.getElementById('up-item-'+id);if(item)item.querySelector('.up-row-1 span').style.textDecoration='line-through'}}async function handleDrop(e){const items=e.dataTransfer.items;if(!items)return;e.preventDefault();const entries=[];for(let i=0;i<items.length;i++){const entry=items[i].webkitGetAsEntry?items[i].webkitGetAsEntry():null;if(entry)entries.push(entry)}if(entries.length>0){document.getElementById('upload-panel').classList.add('show');for(const entry of entries){await traverseFileTree(entry)}}uploadNext()}async function traverseFileTree(item,path=''){if(item.isFile){item.file(file=>{const id=Date.now()+'_'+Math.random().toString(36).substr(2,9);const fullPath=path+file.name;addUploadItem(id,fullPath,file.size);uploadQueue.push({file:file,id:id,relPath:fullPath});totalFiles++;updateHeader()})}else if(item.isDirectory){const dirReader=item.createReader();const readEntries=async()=>{const entries=await new Promise(resolve=>dirReader.readEntries(resolve));if(entries.length>0){for(const entry of entries){await traverseFileTree(entry,path+item.name+"/")}await readEntries()}};await readEntries()}}function handleUpload(files){if(!files||files.length===0)return;document.getElementById('upload-panel').classList.add('show');const arr=Array.from(files);arr.forEach(f=>{const id=Date.now()+'_'+Math.random().toString(36).substr(2,9);addUploadItem(id,f.name,f.size);uploadQueue.push({file:f,id:id,relPath:f.name});totalFiles++});updateHeader();uploadNext()}function showToast(msg,type){const d=document.createElement('div');d.className=`toast ${type}`;d.innerHTML=`<i class="fas fa-info-circle"></i> ${msg}`;document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000)}function t(k){return(LANG[curLang]&&LANG[curLang][k])||k}function submitKeyForm(){const name=document.getElementById('k-name').value.trim();const bal=document.getElementById('k-bal').value;const time=document.getElementById('k-time').value;const port=document.getElementById('k-port').value;const rate=document.getElementById('k-rate').value;const web=document.getElementById('k-web').checked;if(!name)return showToast(t('msg_name_req'),"danger");if(isEditMode&&name!==originalKeyName){ws.send(`key del ${originalKeyName}`);ws.send(`key add ${name} ${bal} ${time} ${port} ${rate} ${web}`)}else if(isEditMode){ws.send(`key set ${name} b=${bal} r=${rate} p=${port} t=${time} w=${web}`)}else{ws.send(`key add ${name} ${bal} ${time} ${port} ${rate} ${web}`)}if(isEditMode)exitEditMode();else{document.getElementById('k-name').value='';document.getElementById('k-bal').value='1024';initDatePicker()}setTimeout(refreshKeys,500)}function editKey(name,bal,time,port,rate,web){isEditMode=true;originalKeyName=name;document.getElementById('key-form-title').innerText=t('key_edit_title');document.getElementById('btn-submit-key').innerText=t('btn_save');document.getElementById('btn-cancel-edit').style.display='inline-flex';document.getElementById('k-name').value=name;document.getElementById('k-bal').value=bal;document.getElementById('k-time').value=time;document.getElementById('k-port').value=port;document.getElementById('k-rate').value=rate;document.getElementById('k-web').checked=web;document.getElementById('k-name').focus()}function exitEditMode(){isEditMode=false;originalKeyName="";document.getElementById('key-form-title').innerText=t('key_create_title');document.getElementById('btn-submit-key').innerText=t('btn_create');document.getElementById('btn-cancel-edit').style.display='none';document.getElementById('k-name').value=''}function doBanIp(){const ip=banInput.value.trim();if(ip){reqBanIp(ip);banInput.value=''}}function formatBytes(bytes,decimals=2){if(bytes===0)return'0 B';const k=1024;const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(decimals<0?0:decimals))+' '+['B','KB','MB','GB','TB'][i]}function fmtSize(s){if(s<1024)return s+"B";if(s<1048576)return(s/1024).toFixed(1)+"KB";return(s/1048576).toFixed(1)+"MB"}function logRaw(text){const div=document.createElement('div');div.className='log-entry';if(text.startsWith('>')){div.className='log-cmd';div.textContent=text}else if(text.startsWith('[')){const r=/^\[(.*?)\] \[(.*?)\] \[(.*?)\]: (.*)$/;const m=text.match(r);if(m){const[_,t,l,s,c]=m;let h=`<span class="l-time">[${t}]</span> <span class="l-lvl ${l}">[${l}]</span> <span class="l-src">[${s}]</span>: `;const ir=/((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|([\da-fA-F]{1,4}:){7}[\da-fA-F]{1,4}|([\da-fA-F]{1,4}:){1,7}:|:((:[\da-fA-F]{1,4}){1,7}|:)/g;h+=`<span class="l-text">${escapeHtml(c).replace(ir,m=>`<span class="l-ip">${m}</span>`)}</span>`;div.innerHTML=h}else div.textContent=text}else div.textContent=text;termOutput.appendChild(div);requestAnimationFrame(()=>termOutput.scrollTop=termOutput.scrollHeight)}function logLogo(text){const div=document.createElement('div');div.className='log-logo';div.textContent=text;termOutput.appendChild(div);requestAnimationFrame(()=>termOutput.scrollTop=termOutput.scrollHeight)}function sendCmd(){const val=cmdInput.value.trim();if(val&&ws.readyState===1){ws.send(val);cmdInput.value=''}}function checkAndParseTableData(rawPayload){let content=rawPayload;const match=content.match(/^\[.*?\] \[.*?\] \[.*?\]: ([\s\S]*)$/);if(match)content=match[1];if(content.includes("┌")||content.includes("│")){handleTableData(content);isExpectingTable=false;document.getElementById(tableTarget+'-table-wrapper').innerHTML="";handleTableData(content);return}const emptyKeywords=["No active HostClient","没有活跃的 HostClient","Ban list is empty","封禁列表为空","No data to display","没有数据可显示"];for(let key of emptyKeywords){if(content.includes(key)){renderEmptyTable(tableTarget);isExpectingTable=false;return}}}function renderEmptyTable(type){const div=document.getElementById(type+'-table-wrapper');if(div)div.innerHTML=`<div style="padding:2rem;text-align:center;color:var(--text-sub)"><span data-i18n="no_data">${t('no_data')}</span></div>`}function handleTableData(data){const lines=data.split('\n');let cl=[];let fs=false;for(let l of lines){if(!fs&&(l.includes('┌')||l.includes('|')||l.includes('│'))){const s=Math.max(l.indexOf('┌'),Math.max(l.indexOf('|'),l.indexOf('│')));if(s!==-1){fs=true;cl.push(l.substring(s));continue}}if(fs)cl.push(l)}const parsed=parseAsciiTable(cl.join('\n'));if(tableTarget==='key')renderKeyTable(parsed);else if(tableTarget==='client')renderClientTable(parsed);else if(tableTarget==='ban')renderBanTable(parsed)}function parseAsciiTable(t){const lines=t.split('\n').filter(l=>(l.includes('│')||l.includes('|'))&&!l.includes('┌')&&!l.includes('├')&&!l.includes('└')&&!l.includes('─'));if(lines.length<2)return null;const split=l=>{let p=l.split(/[│|]/);if(p.length>0&&p[0].trim()==='')p.shift();if(p.length>0&&p[p.length-1].trim()==='')p.pop();return p.map(s=>s.trim())};const headers=split(lines[0]);const rows=[];let last=null;for(let i=1;i<lines.length;i++){const c=split(lines[i]);if(c.length===headers.length){if(c.every(s=>s===''))continue;if(c[0]===''&&last){for(let j=0;j<c.length;j++)if(c[j])last[j]+='<br>'+c[j]}else{last=c;rows.push(last)}}}return{headers,rows}}function refreshKeys(){isExpectingTable=true;tableTarget='key';document.getElementById('key-table-wrapper').innerHTML=`<div style="padding:2rem;text-align:center;color:var(--text-sub)"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">${t('loading')}</span></div>`;ws.send('key list')}function refreshClients(){isExpectingTable=true;tableTarget='client';document.getElementById('client-table-wrapper').innerHTML=`<div style="padding:2rem;text-align:center;color:var(--text-sub)"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">${t('loading')}</span></div>`;ws.send('list')}function refreshBans(){isExpectingTable=true;tableTarget='ban';document.getElementById('ban-table-wrapper').innerHTML=`<div style="padding:2rem;text-align:center;color:var(--text-sub)"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">${t('loading')}</span></div>`;ws.send('listbans')}function renderKeyTable(data){lastKeyData=data;const div=document.getElementById('key-table-wrapper');if(!data)return renderEmptyTable('key');let h='<table><thead><tr>';const hKeys=['th_name','th_bal','th_time','th_port','th_rate','st_enable'];hKeys.forEach(k=>h+=`<th>${t(k)}</th>`);h+=`<th>WebHTML</th>`;h+=`<th>${t('th_op')}</th></tr></thead><tbody>`;data.rows.forEach(row=>{if(row.length>0){let name=row[0];if(!name)return;const isRemote=name.includes('(R)');const cleanName=name.replace(/ \([RL]\)$/,'');const isEn=row[5].includes('✓')||row[5].includes('true');const isWeb=row[6].includes('✓')||row[6].includes('true');const rate=row[4].replace('mbps','');h+='<tr>';row.forEach((c,i)=>{if(i===1)c+=' MiB';if(i===5)c=isEn?`<span style="color:var(--success)">● ${t('st_enable')}</span>`:`<span style="color:var(--text-sub)">○ ${t('st_disable')}</span>`;if(i===6)c=isWeb?`<span style="color:var(--accent)">● ${t('st_on')}</span>`:`<span style="color:var(--text-sub)">○ ${t('st_off')}</span>`;if(i!==7)h+=`<td>${c}</td>`});if(isRemote){h+=`<td><button class="btn btn-action" disabled style="opacity:0.6;cursor:not-allowed;border-style:dashed" title="${t('tip_remote_key')}"><i class="fas fa-lock"></i></button></td>`}else{const editArgs=`'${cleanName}','${row[1]}','${row[2]}','${row[3]}','${rate}',${isWeb}`;h+=`<td><button class="btn btn-action" title="${t('act_edit')}" onclick="editKey(${editArgs})"><i class="fas fa-edit"></i></button><button class="btn btn-action" style="width:80px" onclick="ws.send('key ${isEn?'disable':'enable'} ${cleanName}');setTimeout(refreshKeys,500)">${isEn?t('st_disable'):t('st_enable')}</button><button class="btn btn-danger" title="${t('act_del')}" style="min-width:40px" onclick="reqDeleteKey('${cleanName}')"><i class="fas fa-trash"></i></button></td>`}h+='</tr>'}});div.innerHTML=h+'</tbody></table>'}function renderClientTable(data){lastClientData=data;const div=document.getElementById('client-table-wrapper');if(!data)return renderEmptyTable('client');let h=`<table><thead><tr><th>IP</th><th>${t('th_name')}</th><th>${t('th_loc')}</th><th>${t('th_isp')}</th><th>${t('th_port')}</th><th>${t('th_ext')}</th><th>${t('th_op')}</th></tr></thead><tbody>`;data.rows.forEach(row=>{if(row.length>=4){const ip=row[0];if(!ip)return;let loc=row[2];if(loc===''||loc==='null')loc=t('unknown');const locHtml=`<div style="display:flex; align-items:center; gap:8px;"><span>${loc}</span><button class="btn btn-action btn-sm" onclick="ws.send('#REFRESH_LOC:${ip}')"><i class="fas fa-sync-alt"></i></button></div>`;h+=`<tr><td>${ip}</td><td>${row[1]}</td><td>${locHtml}</td><td>${row[3]}</td><td>${row[4]||'-'}</td><td>${row[5]||'0'}</td><td><button class="btn btn-danger" onclick="reqBanIp('${ip}')"><i class="fas fa-ban"></i> ${t('act_ban')}</button></td></tr>`}});div.innerHTML=h+'</tbody></table>'}function renderBanTable(data){lastBanData=data;const div=document.getElementById('ban-table-wrapper');if(!data)return renderEmptyTable('ban');let h=`<table><thead><tr><th>${t('th_ip')}</th><th>${t('th_loc')}</th><th>${t('th_isp')}</th><th>${t('th_op')}</th></tr></thead><tbody>`;data.rows.forEach(row=>{const ip=row[0];if(!ip)return;const loc=row[1]||t('unknown');const isp=row[2]||'-';h+=`<tr><td><span class="l-ip">${ip}</span></td><td>${loc}</td><td>${isp}</td><td><button class="btn btn-action" onclick="ws.send('unban ${ip}');setTimeout(refreshBans,500)"><i class="fas fa-unlock"></i> ${t('act_unban')}</button></td></tr>`});div.innerHTML=h+'</tbody></table>'}function initDatePicker(){const d=new Date();d.setDate(d.getDate()+30);const p=n=>String(n).padStart(2,'0');const el=document.getElementById('k-time');if(el)el.value=`${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())}-23:59`}function setChartRange(range){chartRange=range;document.querySelectorAll('.chart-btn').forEach(b=>b.classList.remove('active'));const btn=document.querySelector(`.chart-btn[onclick="setChartRange(${range})"]`);if(btn)btn.classList.add('active');drawChart()}function updateDashboard(data){document.getElementById('d-hc').innerText=data.hc;document.getElementById('d-ec').innerText=data.ec+(data.uc||0);document.getElementById('d-ver').innerText=data.v;document.getElementById('d-sver').innerText=data.sv;document.getElementById('d-ports').innerText=data.p;const now=Date.now();let speed=0;if(lastTotalBalance!==-1&&lastFetchTime>0){const diffMb=lastTotalBalance-data.tb;if(diffMb>=0){const dt=(now-lastFetchTime)/1000;if(dt>0)speed=(diffMb*1024*1024)/dt}}lastTotalBalance=data.tb;lastFetchTime=now;trafficHistory.push({t:now,v:speed});const cutoff=now-(11*60*1000);while(trafficHistory.length>0&&trafficHistory[0].t<cutoff)trafficHistory.shift();document.getElementById('d-speed').innerText=formatBytes(speed)+"/s";drawChart()}function drawChart(){const container=document.querySelector('.chart-container');const svg=document.getElementById('traffic-chart');const w=container.clientWidth;const h=container.clientHeight;svg.setAttribute('viewBox',`0 0 ${w} ${h}`);const now=Date.now();const startTime=now-(chartRange*1000);const data=trafficHistory.filter(d=>d.t>=startTime);const linesGroup=document.getElementById('chart-grid-lines');linesGroup.innerHTML='';[0.25,0.5,0.75].forEach(p=>{const line=document.createElementNS("http://www.w3.org/2000/svg","line");line.setAttribute("x1",0);line.setAttribute("y1",h*p);line.setAttribute("x2",w);line.setAttribute("y2",h*p);linesGroup.appendChild(line)});if(data.length<2)return;let maxVal=0;data.forEach(d=>{if(d.v>maxVal)maxVal=d.v});if(maxVal<1024)maxVal=1024;const yUnitStr=formatBytes(maxVal).split(' ')[1];const labels=document.getElementById('chart-labels');labels.innerHTML='';const addText=(x,y,txt,anchor='start')=>{const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("x",x);t.setAttribute("y",y);t.setAttribute("class","chart-text");t.setAttribute("text-anchor",anchor);t.textContent=txt;labels.appendChild(t)};addText(5,15,formatBytes(maxVal)+"/s");addText(5,h/2+5,formatBytes(maxVal/2)+"/s");addText(5,h-18,"0 "+yUnitStr+"/s");const dStart=new Date(startTime);const dEnd=new Date(now);const fmtTime=d=>d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')+':'+d.getSeconds().toString().padStart(2,'0');addText(5,h-5,fmtTime(dStart));addText(w-5,h-5,fmtTime(dEnd),'end');let pathD="";data.forEach((pt,i)=>{const x=((pt.t-startTime)/(chartRange*1000))*w;const y=h-((pt.v/maxVal)*h);const clX=Math.max(0,Math.min(w,x));if(i===0)pathD+=`M ${clX} ${y} `;else pathD+=`L ${clX} ${y} `});if(pathD){document.getElementById('chart-line').setAttribute('d',pathD);const areaD=pathD+` L ${w} ${h} L 0 ${h} Z`;document.getElementById('chart-area').setAttribute('d',areaD)}}function showContextMenu(e,item){const menu=document.getElementById('context-menu');menu.style.display='flex';menu.style.top=e.pageY+'px';menu.style.left=e.pageX+'px';const w=window.innerWidth;const h=window.innerHeight;if(e.pageX+180>w)menu.style.left=(w-190)+'px';if(e.pageY+200>h)menu.style.top=(h-210)+'px';let html='';const token=new URLSearchParams(location.search).get('token');if(item){document.querySelectorAll('.file-item').forEach(el=>el.classList.remove('context-active'));const el=e.target.closest('.file-item');if(el)el.classList.add('context-active');if(item.isDir){html+=`<div class="context-item" onclick="loadDir('${item.path}')"><i class="fas fa-folder-open"></i> ${t('ctx_open')}</div>`}else{html+=`<div class="context-item" onclick="reqEdit('${item.path}')"><i class="fas fa-edit"></i> ${t('ctx_open')}</div><div class="context-item" onclick="window.open('/download?file=${encodeURIComponent(item.path)}&token=${token}')"><i class="fas fa-download"></i> ${t('ctx_download')}</div>`}html+=`<div class="context-sep"></div><div class="context-item" onclick="copyFile('${item.name}','copy')"><i class="fas fa-copy"></i> ${t('ctx_copy')}</div><div class="context-item" onclick="copyFile('${item.name}','cut')"><i class="fas fa-cut"></i> ${t('ctx_cut')}</div><div class="context-sep"></div><div class="context-item" onclick="openInputModal('${t('ctx_rename')}','${item.name}').then(v=>{if(v&&v!=='${item.name}'){if(v.includes('/')||v.includes('\\\\')){showToast(t('msg_name_invalid'),'danger');}else{ws.send('#RENAME_FILE:'+curPath+'|'+'${item.name}'+'|'+v);showToast(t('msg_renamed'),'success');}}})"><i class="fas fa-i-cursor"></i> ${t('ctx_rename')}</div><div class="context-item" onclick="selectedFiles.clear();selectedFiles.add('${item.name}');openMoveSelector()"><i class="fas fa-dolly"></i> ${t('ctx_move')}</div><div class="context-item danger" onclick="reqDeleteFile('${item.path}','${item.name}')"><i class="fas fa-trash"></i> ${t('ctx_delete')}</div><div class="context-sep"></div><div class="context-item" onclick="showProperties('${item.name}', ${item.size}, ${item.isDir}, '${item.path}', ${item.time})"><i class="fas fa-info-circle"></i> ${t('ctx_props')}</div>`}else{html+=`<div class="context-item" onclick="refreshFiles()"><i class="fas fa-sync-alt"></i> ${t('btn_refresh')}</div>`;if(clipboardFiles.size>0){html+=`<div class="context-sep"></div><div class="context-item" onclick="pasteFiles()"><i class="fas fa-paste"></i> ${t('ctx_paste')} (${clipboardFiles.size})</div>`}}menu.innerHTML=html}function copyFile(name,action){clipboardFiles.clear();if(selectedFiles.has(name)&&selectedFiles.size>1){selectedFiles.forEach(f=>clipboardFiles.add(f))}else{clipboardFiles.add(name)}clipboardAction=action;showPasteFab()}function showPasteFab(){const fab=document.getElementById('paste-fab');fab.classList.add('show');document.getElementById('paste-count').innerText=`${clipboardFiles.size} Files`;document.getElementById('paste-action').innerText=clipboardAction==='copy'?t('ctx_copy'):t('ctx_cut')}function clearClipboard(){clipboardFiles.clear();document.getElementById('paste-fab').classList.remove('show')}function pasteFiles(){if(clipboardFiles.size===0)return;let cmd=clipboardAction==='cut'?'#MOVE_FILES:':'#COPY_FILES:';cmd+=curPath;clipboardFiles.forEach(f=>cmd+="|"+(curPath?curPath+"/":"")+f);ws.send(cmd);if(clipboardAction==='cut')clearClipboard();else showToast(t('msg_pasted'),'success');refreshFiles()}function openMoveSelector(){if(selectedFiles.size===0)return;moveModalPath="";fileRequestTarget='modal';document.getElementById('move-modal').classList.add('show');document.getElementById('move-modal').style.display='flex';loadMoveDir("")}function closeMoveModal(){document.getElementById('move-modal').classList.remove('show');setTimeout(()=>document.getElementById('move-modal').style.display='none',300);fileRequestTarget='view'}function loadMoveDir(path){moveModalPath=path;document.getElementById('move-current-path').innerText=path||"/";document.getElementById('move-list').innerHTML=`<div style="padding:1rem;text-align:center"><span data-i18n="loading">Loading...</span></div>`;ws.send("#GET_FILES:"+path)}function moveGoUp(){if(!moveModalPath)return;const parts=moveModalPath.split('/');parts.pop();loadMoveDir(parts.join('/'))}function renderMoveList(list,path){const div=document.getElementById('move-list');if(!list){div.innerHTML=`<div style="padding:1rem;text-align:center;color:var(--text-sub)"><span data-i18n="move_no_subs">${t('move_no_subs')}</span></div>`;return}const dirs=list.filter(f=>f.isDir&&f.name!=='..').sort((a,b)=>a.name.localeCompare(b.name));if(dirs.length===0)div.innerHTML=`<div style="padding:1rem;text-align:center;color:var(--text-sub)"><span data-i18n="move_no_subs">${t('move_no_subs')}</span></div>`;else div.innerHTML=dirs.map(d=>`<div class="move-item" onclick="loadMoveDir('${(path?path+"/":"")+d.name}')"><i class="fas fa-folder" style="color:var(--warning)"></i> ${d.name}</div>`).join('')}function confirmMove(){reqMoveTo(moveModalPath);closeMoveModal()}function showProperties(name,size,isDir,path,time){const modal=document.getElementById('props-modal');const body=document.getElementById('props-body');modal.classList.add('show');modal.style.display='flex';let html='';if(selectedFiles.size>1&&selectedFiles.has(name)){let count=selectedFiles.size;let totalSize=0;let fCount=0;let dCount=0;currentFileList.forEach(f=>{if(selectedFiles.has(f.name)){totalSize+=f.size;if(f.isDir)dCount++;else fCount++}});html+=`<div class="prop-row"><span class="prop-k">${t('prop_count')}</span><span class="prop-v">${count}</span></div><div class="prop-row"><span class="prop-k">${t('prop_files')}</span><span class="prop-v">${fCount}</span></div><div class="prop-row"><span class="prop-k">${t('prop_folders')}</span><span class="prop-v">${dCount}</span></div><div class="prop-row"><span class="prop-k">${t('prop_total_size')}</span><span class="prop-v">${fmtSize(totalSize)}<br><span style="font-size:0.7rem;color:var(--text-sub)">(${totalSize.toLocaleString()} bytes)</span></span></div>`}else{let timeStr='-';if(time){const d=new Date(time);timeStr=d.toLocaleString()}html+=`<div style="text-align:center;margin-bottom:1rem"><i class="fas ${getFileIcon(name,isDir)}" style="font-size:3rem;color:var(--accent)"></i><div style="font-weight:bold;margin-top:10px;word-break:break-all">${name}</div></div><div class="prop-row"><span class="prop-k">${t('prop_type')}</span><span class="prop-v">${isDir?'Folder':'File'}</span></div><div class="prop-row"><span class="prop-k">${t('prop_path')}</span><span class="prop-v">${path}</span></div><div class="prop-row"><span class="prop-k">${t('prop_size')}</span><span class="prop-v">${isDir?'-':(fmtSize(size)+'<br><span style="font-size:0.7rem;color:var(--text-sub)">('+size.toLocaleString()+' bytes)</span>')}</span></div><div class="prop-row"><span class="prop-k">${t('prop_time')}</span><span class="prop-v">${timeStr}</span></div>`}body.innerHTML=html}function createFolderInMoveMode(){openInputModal(t('modal_new_folder'),t('move_new_folder_ph')).then(name=>{if(name){ws.send("#CREATE_DIR:"+moveModalPath+"|"+name);setTimeout(()=>loadMoveDir(moveModalPath),300)}})}init()
</script>
</body>
</html>